<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manutenção Frota</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        /* Estilo para campos customizados */
        .custom-input {
            display: none;
            margin-top: 8px;
        }

        .custom-input.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO - URL GOOGLE SCRIPT CONFIGURADA
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUG8D5F8IDCvLnY200nckHpMpKOWJvSIHsfmowCdI_3m_8dVDdz0WOB6KQho5rr2s28w/exec';
        
        // Intervalo de sincronização automática (em milissegundos)
        const SYNC_INTERVAL = 30000; // 30 segundos
        
        let syncIntervalId = null;
        let lastSyncTime = null;

        // ============================================
        // DADOS DA FROTA
        // ============================================
        const FLEET_DATA = {
            "CZC-0453": "CAMINHÃO ALTA PRESSÃO",
            "DSY6472": "CAMINHÃO ALTA PRESSÃO",
            "DSY6474": "CAMINHÃO ALTA PRESSÃO",
            "DSY6475": "CAMINHÃO ALTA PRESSÃO",
            "DSY6F81": "CAMINHÃO ALTA PRESSÃO",
            "EAM-3253": "CAMINHÃO ALTA PRESSÃO",
            "EAM3255": "CAMINHÃO ALTA PRESSÃO",
            "EAM3256": "CAMINHÃO ALTA PRESSÃO",
            "EAM3262": "CAMINHÃO ALTA PRESSÃO",
            "EGC2978": "CAMINHÃO ALTA PRESSÃO",
            "EGC2983": "CAMINHÃO ALTA PRESSÃO",
            "EGC2985": "CAMINHÃO ALTA PRESSÃO",
            "EGC2989": "CAMINHÃO ALTA PRESSÃO",
            "EZS8764": "CAMINHÃO ALTA PRESSÃO",
            "LUX-3201": "CAMINHÃO ALTA PRESSÃO",
            "PUB2F80": "CAMINHÃO ALTA PRESSÃO",
            "ALY5322": "CAMINHÃO AUTO VÁCUO",
            "ANF-2676": "CAMINHÃO AUTO VÁCUO",
            "CUB0763": "CAMINHÃO AUTO VÁCUO",
            "DSY6473": "CAMINHÃO AUTO VÁCUO",
            "DSY6577": "CAMINHÃO AUTO VÁCUO",
            "DYB7210": "CAMINHÃO AUTO VÁCUO",
            "EAM3251": "CAMINHÃO AUTO VÁCUO",
            "EAM3257": "CAMINHÃO AUTO VÁCUO",
            "EGC2993": "CAMINHÃO AUTO VÁCUO",
            "FSA3D71": "CAMINHÃO AUTO VÁCUO",
            "HJS1097": "CAMINHÃO AUTO VÁCUO",
            "DSY6477": "CAMINHÃO BROOK",
            "EGC-2984": "CAMINHÃO BROOK",
            "EPN2463": "CAMINHÃO BROOK",
            "HKH2H79": "CAMINHÃO BROOK",
            "DSY6471": "CAMINHÃO HIPER VÁCUO",
            "FHD9264": "CAMINHÃO HIPER VÁCUO",
            "FMD2200": "CAMINHÃO HIPER VÁCUO",
            "ASP02": "ASPIRADOR",
            "ASP04": "ASPIRADOR",
            "ASP06": "ASPIRADOR",
            "ASP07": "ASPIRADOR",
            "ASP08": "ASPIRADOR",
            "ASP09": "ASPIRADOR",
            "ASP10": "ASPIRADOR",
            "ASP12": "ASPIRADOR",
            "ASP12-RESERVA": "ASPIRADOR",
            "ASPII": "ASPIRADOR"
        };

        const MAINTENANCE_TYPES = [
            "Preventiva",
            "Corretiva",
            "Preditiva",
            "Emergencial",
            "Outro" // Opção customizável
        ];

        const WORKSHOPS = [
            "Oficina Interna",
            "Oficina Externa - A definir",
            "Mecânica Diesel",
            "Especializada Bomba",
            "Especializada Hidráulica",
            "Concessionária",
            "Em Campo (Emergencial)",
            "Outro" // Opção customizável
        ];

        const FAILURES_BY_TYPE = {
            "CAMINHÃO ALTA PRESSÃO": [
                "Bomba Alta Pressão", "Mangueira Alta Pressão", "Bico Rotativo", "Motor Bomba",
                "Sistema Hidráulico", "Válvulas de Pressão", "Filtros Bomba", "Tanque de Água",
                "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"
            ],
            "CAMINHÃO AUTO VÁCUO": [
                "Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga",
                "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico",
                "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"
            ],
            "CAMINHÃO HIPER VÁCUO": [
                "Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga",
                "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico",
                "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"
            ],
            "CAMINHÃO BROOK": [
                "Sistema de Desobstrução", "Lança/Braço Mecânico", "Mangueiras", "Sistema Hidráulico",
                "Cabos de Aço", "Filtros",
                "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"
            ],
            "ASPIRADOR": [
                "Motor de Sucção", "Filtros", "Mangueiras", "Sistema Elétrico", "Tanque", "Outro"
            ]
        };

        const PRIORITIES = ["URGENTE", "ALTA", "MEDIA", "BAIXA"];

        const STATUS_OPTIONS = ["Aberta", "Em Andamento", "Aguardando Peças", "Concluída", "Cancelada"];

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let state = {
            view: 'login', // login, form, success, history
            supervisor: '',
            editingId: null, // ID do registro sendo editado
            placa: '',
            tipoEquipamento: '',
            tipoManutencao: '',
            tipoManutencaoCustom: '',
            prioridade: '',
            tipoAvaria: '',
            tipoAvariaCustom: '',
            descricao: '',
            local: '',
            oficina: '',
            oficinaCustom: '',
            responsavel: '',
            observacoes: '',
            statusOrdem: 'Aberta',
            searchTerm: '',
            isLoading: false,
            isSyncing: false,
            locationCoords: null,
            historyFilter: 'all',
            showCustomManutencao: false,
            showCustomOficina: false,
            showCustomAvaria: false
        };

        // ============================================
        // FUNÇÕES DE UTILIDADE
        // ============================================
        function getPriorityColor(priority) {
            const colors = {
                'URGENTE': 'bg-red-500 text-white border-red-500',
                'ALTA': 'bg-orange-500 text-white border-orange-500',
                'MEDIA': 'bg-yellow-400 text-black border-yellow-400',
                'BAIXA': 'bg-green-500 text-white border-green-500'
            };
            return colors[priority] || 'bg-white text-gray-600 border-gray-300';
        }

        function getPriorityColorHistory(priority) {
            const colors = {
                'URGENTE': 'bg-red-100 text-red-800 border-red-300',
                'ALTA': 'bg-orange-100 text-orange-800 border-orange-300',
                'MEDIA': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'BAIXA': 'bg-green-100 text-green-800 border-green-300'
            };
            return colors[priority] || 'bg-gray-100 text-gray-800 border-gray-300';
        }

        function getStatusColor(status) {
            const colors = {
                'Aberta': 'bg-blue-100 text-blue-800',
                'Em Andamento': 'bg-yellow-100 text-yellow-800',
                'Aguardando Peças': 'bg-orange-100 text-orange-800',
                'Concluída': 'bg-green-100 text-green-800',
                'Cancelada': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(isoDate) {
            const date = new Date(isoDate);
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${d}/${m}/${y} ${h}:${min}`;
        }

        function getFilteredPlates() {
            return Object.keys(FLEET_DATA).filter(p => 
                p.toLowerCase().includes(state.searchTerm.toLowerCase())
            );
        }

        function getMaintenanceHistory() {
            const history = localStorage.getItem('maintenance_history');
            return history ? JSON.parse(history) : [];
        }

        function saveToHistory(record) {
            const history = getMaintenanceHistory();
            const existingIndex = history.findIndex(r => r.id === record.id);
            
            if (existingIndex !== -1) {
                // Atualiza registro existente
                history[existingIndex] = record;
            } else {
                // Adiciona novo registro
                history.unshift(record);
            }
            
            localStorage.setItem('maintenance_history', JSON.stringify(history));
        }

        function updateHistoryStatus(id, status) {
            const history = getMaintenanceHistory();
            const index = history.findIndex(r => r.id === id);
            if (index !== -1) {
                history[index].status = status;
                localStorage.setItem('maintenance_history', JSON.stringify(history));
            }
        }

        // ============================================
        // GEOCODIFICAÇÃO REVERSA (LAT/LNG → ENDEREÇO)
        // ============================================
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=pt-BR`,
                    {
                        headers: {
                            'User-Agent': 'ManutencaoFrotaApp/1.0'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Erro na geocodificação');
                
                const data = await response.json();
                
                if (data.display_name) {
                    return data.display_name;
                } else if (data.address) {
                    // Monta endereço manualmente
                    const addr = data.address;
                    let parts = [];
                    if (addr.road) parts.push(addr.road);
                    if (addr.house_number) parts.push(addr.house_number);
                    if (addr.suburb) parts.push(addr.suburb);
                    if (addr.city) parts.push(addr.city);
                    if (addr.state) parts.push(addr.state);
                    return parts.join(', ');
                }
                
                return `GPS: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            } catch (error) {
                console.error('Erro na geocodificação:', error);
                return `GPS: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            }
        }

        // ============================================
        // INTEGRAÇÃO GOOGLE SHEETS
        // ============================================
        async function submitToSheet(record) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(record),
                    redirect: 'follow'
                });
                
                console.log('Resposta do servidor:', response.status);
                
                // Com Apps Script, mesmo com no-cors, se chegou aqui sem erro, consideramos sucesso
                return { success: true };
                
            } catch (error) {
                console.error('Erro ao enviar para Google Sheets:', error);
                return { success: false, message: error.message };
            }
        }

        async function fetchFromSheet() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=get', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.records) {
                    // Atualiza localStorage com dados da planilha
                    localStorage.setItem('maintenance_history', JSON.stringify(data.records));
                    lastSyncTime = new Date();
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Erro ao buscar do Google Sheets:', error);
                return false;
            }
        }

        async function syncWithSheet() {
            if (state.isSyncing) return;
            
            state.isSyncing = true;
            render();
            
            const success = await fetchFromSheet();
            
            state.isSyncing = false;
            render();
            
            return success;
        }

        function startAutoSync() {
            if (syncIntervalId) {
                clearInterval(syncIntervalId);
            }
            
            syncIntervalId = setInterval(async () => {
                console.log('Auto-sincronização iniciada...');
                await syncWithSheet();
            }, SYNC_INTERVAL);
        }

        function stopAutoSync() {
            if (syncIntervalId) {
                clearInterval(syncIntervalId);
                syncIntervalId = null;
            }
        }

        // ============================================
        // HANDLERS
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            if (!state.supervisor.trim()) return;
            localStorage.setItem('supervisor_name', state.supervisor);
            state.view = 'form';
            startAutoSync(); // Inicia sincronização automática
            render();
        }

        function handleLogout() {
            stopAutoSync(); // Para sincronização automática
            localStorage.removeItem('supervisor_name');
            state.supervisor = '';
            state.view = 'login';
            render();
        }

        function handlePlacaChange(placa) {
            state.placa = placa;
            state.tipoEquipamento = FLEET_DATA[placa] || '';
            state.tipoAvaria = '';
            state.tipoAvariaCustom = '';
            state.showCustomAvaria = false;
            state.searchTerm = '';
            render();
        }

        function handleManutencaoChange(value) {
            state.tipoManutencao = value;
            state.showCustomManutencao = (value === 'Outro');
            if (value !== 'Outro') {
                state.tipoManutencaoCustom = '';
            }
            render();
        }

        function handleOficinaChange(value) {
            state.oficina = value;
            state.showCustomOficina = (value === 'Outro');
            if (value !== 'Outro') {
                state.oficinaCustom = '';
            }
            render();
        }

        function handleAvariaChange(value) {
            state.tipoAvaria = value;
            state.showCustomAvaria = (value === 'Outro');
            if (value !== 'Outro') {
                state.tipoAvariaCustom = '';
            }
            render();
        }

        async function handleGetLocation() {
            if (navigator.geolocation) {
                state.isLoading = true;
                render();
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        state.locationCoords = { lat, lng };
                        
                        // Busca endereço legível
                        const address = await reverseGeocode(lat, lng);
                        state.local = address;
                        
                        state.isLoading = false;
                        render();
                    },
                    (error) => {
                        console.error("Error getting location", error);
                        alert("Não foi possível obter a localização. Verifique as permissões.");
                        state.isLoading = false;
                        render();
                    }
                );
            } else {
                alert("Geolocalização não suportada neste navegador.");
            }
        }

        async function handleSubmit() {
            const { placa, tipoManutencao, tipoManutencaoCustom, prioridade, tipoAvaria, 
                    tipoAvariaCustom, descricao, local, oficina, oficinaCustom, responsavel } = state;
            
            // Validação básica (sem mínimo de caracteres)
            if (!placa || !prioridade || !descricao || !local || !responsavel) {
                alert("Por favor, preencha todos os campos obrigatórios marcados com *");
                return;
            }

            // Determina valor final dos campos com opção "Outro"
            const finalManutencao = tipoManutencao === 'Outro' ? tipoManutencaoCustom : tipoManutencao;
            const finalOficina = oficina === 'Outro' ? oficinaCustom : oficina;
            const finalAvaria = tipoAvaria === 'Outro' ? tipoAvariaCustom : tipoAvaria;

            if (!finalManutencao || !finalOficina || !finalAvaria) {
                alert("Por favor, preencha todos os campos obrigatórios.");
                return;
            }

            state.isLoading = true;
            render();

            const recordId = state.editingId || `${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${Math.floor(Math.random() * 10000)}`;

            const newRecord = {
                id: recordId,
                dataHora: new Date().toISOString(),
                supervisor: state.supervisor,
                placa: state.placa,
                tipoEquipamento: state.tipoEquipamento,
                tipoManutencao: finalManutencao,
                prioridade: state.prioridade,
                tipoAvaria: finalAvaria,
                descricaoAvaria: state.descricao,
                localManutencao: state.local,
                oficina: finalOficina,
                responsavelManutencao: state.responsavel,
                observacoes: state.observacoes,
                statusOrdem: state.statusOrdem,
                latitude: state.locationCoords?.lat,
                longitude: state.locationCoords?.lng,
                status: 'pending'
            };

            // Salva localmente
            saveToHistory(newRecord);

            // Tenta enviar para Google Sheets
            const result = await submitToSheet(newRecord);

            state.isLoading = false;

            if (result.success) {
                updateHistoryStatus(newRecord.id, 'synced');
            }

            state.view = 'success';
            state.editingId = null; // Limpa modo de edição
            render();
        }

        function loadRecordForEdit(recordId) {
            const history = getMaintenanceHistory();
            const record = history.find(r => r.id === recordId);
            
            if (!record) {
                alert('Registro não encontrado');
                return;
            }

            // Preenche o estado com os dados do registro
            state.editingId = record.id;
            state.placa = record.placa;
            state.tipoEquipamento = record.tipoEquipamento;
            
            // Verifica se é valor customizado
            if (MAINTENANCE_TYPES.includes(record.tipoManutencao)) {
                state.tipoManutencao = record.tipoManutencao;
                state.tipoManutencaoCustom = '';
                state.showCustomManutencao = false;
            } else {
                state.tipoManutencao = 'Outro';
                state.tipoManutencaoCustom = record.tipoManutencao;
                state.showCustomManutencao = true;
            }

            state.prioridade = record.prioridade;
            
            const availableFailures = FAILURES_BY_TYPE[record.tipoEquipamento] || [];
            if (availableFailures.includes(record.tipoAvaria)) {
                state.tipoAvaria = record.tipoAvaria;
                state.tipoAvariaCustom = '';
                state.showCustomAvaria = false;
            } else {
                state.tipoAvaria = 'Outro';
                state.tipoAvariaCustom = record.tipoAvaria;
                state.showCustomAvaria = true;
            }

            state.descricao = record.descricaoAvaria;
            state.local = record.localManutencao;
            
            if (WORKSHOPS.includes(record.oficina)) {
                state.oficina = record.oficina;
                state.oficinaCustom = '';
                state.showCustomOficina = false;
            } else {
                state.oficina = 'Outro';
                state.oficinaCustom = record.oficina;
                state.showCustomOficina = true;
            }

            state.responsavel = record.responsavelManutencao;
            state.observacoes = record.observacoes || '';
            state.statusOrdem = record.statusOrdem || 'Aberta';
            state.locationCoords = record.latitude && record.longitude 
                ? { lat: record.latitude, lng: record.longitude }
                : null;

            state.view = 'form';
            render();

            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function resetForm() {
            state.editingId = null;
            state.placa = '';
            state.tipoEquipamento = '';
            state.tipoManutencao = '';
            state.tipoManutencaoCustom = '';
            state.prioridade = '';
            state.tipoAvaria = '';
            state.tipoAvariaCustom = '';
            state.descricao = '';
            state.local = '';
            state.oficina = '';
            state.oficinaCustom = '';
            state.responsavel = '';
            state.observacoes = '';
            state.statusOrdem = 'Aberta';
            state.searchTerm = '';
            state.locationCoords = null;
            state.showCustomManutencao = false;
            state.showCustomOficina = false;
            state.showCustomAvaria = false;
            state.view = 'form';
            render();
        }

        function clearHistory() {
            if (confirm('Deseja realmente limpar todo o histórico local? (Isso não afeta o Google Sheets)')) {
                localStorage.removeItem('maintenance_history');
                render();
            }
        }

        async function manualSync() {
            const success = await syncWithSheet();
            if (success) {
                alert('Sincronização concluída com sucesso!');
            } else {
                alert('Erro na sincronização. Verifique sua conexão.');
            }
        }

        // ============================================
        // RENDERIZAÇÃO - TELA DE LOGIN
        // ============================================
        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-[#1F4E78]">
                    <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div class="flex justify-center mb-6 text-[#1F4E78]">
                            <i class="ph ph-wrench text-6xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Manutenção Frota</h1>
                        <p class="text-center text-gray-500 mb-8">Identificação do Supervisor</p>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">
                                    Nome do Supervisor <span class="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78] focus:border-transparent"
                                    placeholder="Ex: João Silva"
                                    value="${state.supervisor}"
                                    oninput="state.supervisor = this.value"
                                    required
                                />
                            </div>
                            <button 
                                type="submit" 
                                class="w-full bg-[#70AD47] text-white font-bold py-4 rounded-xl mt-4 active:scale-95 transition-transform shadow-lg"
                            >
                                ENTRAR
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        // ============================================
        // RENDERIZAÇÃO - TELA DE SUCESSO
        // ============================================
        function renderSuccess() {
            const isEdit = state.editingId !== null;
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-white text-center">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                        <i class="ph ph-check text-5xl text-[#70AD47]"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Sucesso!</h2>
                    <p class="text-gray-600 mb-8 max-w-xs mx-auto">
                        ${isEdit ? 'A ordem de manutenção foi atualizada com sucesso.' : 'A ordem de manutenção foi registrada e salva com segurança.'}
                    </p>
                    
                    <button 
                        onclick="resetForm()"
                        class="w-full max-w-sm bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg mb-4"
                    >
                        NOVA MANUTENÇÃO
                    </button>
                    <button 
                        onclick="state.view='history'; render()"
                        class="w-full max-w-sm border-2 border-gray-200 text-gray-600 font-bold py-4 rounded-xl"
                    >
                        VER HISTÓRICO
                    </button>
                </div>
            `;
        }

        // ============================================
        // RENDERIZAÇÃO - HISTÓRICO
        // ============================================
        function renderHistory() {
            const records = getMaintenanceHistory();
            const filtered = records.filter(r => {
                if (state.historyFilter === 'all') return true;
                return r.status === state.historyFilter;
            });

            return `
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-lg text-[#1F4E78]">Histórico</h2>
                            <div class="flex gap-2">
                                <button 
                                    onclick="manualSync()" 
                                    class="text-blue-500 text-sm font-semibold flex items-center gap-1 ${state.isSyncing ? 'opacity-50' : ''}"
                                    ${state.isSyncing ? 'disabled' : ''}
                                >
                                    <i class="ph ph-arrows-clockwise ${state.isSyncing ? 'animate-spin' : ''}"></i>
                                    ${state.isSyncing ? 'Sincronizando...' : 'Sincronizar'}
                                </button>
                                ${records.length > 0 ? `
                                    <button onclick="clearHistory()" class="text-red-500 text-sm font-semibold">
                                        Limpar
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        ${lastSyncTime ? `
                            <p class="text-xs text-gray-500 mb-3">
                                <i class="ph ph-clock"></i> Última sincronização: ${formatDate(lastSyncTime.toISOString())}
                            </p>
                        ` : ''}

                        <div class="flex gap-2 mb-4 overflow-x-auto">
                            <button
                                onclick="state.historyFilter='all'; render()"
                                class="px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap ${state.historyFilter === 'all' ? 'bg-[#1F4E78] text-white' : 'bg-gray-100 text-gray-600'}"
                            >
                                Todos (${records.length})
                            </button>
                            <button
                                onclick="state.historyFilter='synced'; render()"
                                class="px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap ${state.historyFilter === 'synced' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}"
                            >
                                Sincronizados
                            </button>
                            <button
                                onclick="state.historyFilter='pending'; render()"
                                class="px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap ${state.historyFilter === 'pending' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600'}"
                            >
                                Pendentes
                            </button>
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center">
                            <i class="ph ph-clock-counter-clockwise text-5xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Nenhum registro encontrado</p>
                        </div>
                    ` : filtered.map(record => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${record.placa}</h3>
                                    <p class="text-xs text-gray-500">${formatDate(record.dataHora)}</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold border ${getPriorityColorHistory(record.prioridade)}">
                                        ${record.prioridade}
                                    </span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(record.statusOrdem || 'Aberta')}">
                                        ${record.statusOrdem || 'Aberta'}
                                    </span>
                                    ${record.status === 'synced' ? `
                                        <span class="flex items-center gap-1 text-green-600 text-xs">
                                            <i class="ph ph-check-circle"></i> Sincronizado
                                        </span>
                                    ` : `
                                        <span class="flex items-center gap-1 text-orange-600 text-xs">
                                            <i class="ph ph-warning-circle"></i> Pendente
                                        </span>
                                    `}
                                </div>
                            </div>

                            <div class="space-y-2 text-sm mb-3">
                                <div class="flex gap-2">
                                    <span class="font-semibold text-gray-600">Tipo:</span>
                                    <span class="text-gray-800">${record.tipoManutencao}</span>
                                </div>
                                <div class="flex gap-2">
                                    <span class="font-semibold text-gray-600">Avaria:</span>
                                    <span class="text-gray-800">${record.tipoAvaria}</span>
                                </div>
                                <div class="flex gap-2">
                                    <span class="font-semibold text-gray-600">Local:</span>
                                    <span class="text-gray-800">${record.localManutencao}</span>
                                </div>
                                <div class="flex gap-2">
                                    <span class="font-semibold text-gray-600">Oficina:</span>
                                    <span class="text-gray-800">${record.oficina}</span>
                                </div>
                                <div class="flex gap-2">
                                    <span class="font-semibold text-gray-600">Responsável:</span>
                                    <span class="text-gray-800">${record.responsavelManutencao}</span>
                                </div>
                                ${record.descricaoAvaria ? `
                                    <div class="pt-2 border-t border-gray-100">
                                        <span class="font-semibold text-gray-600 block mb-1">Descrição:</span>
                                        <p class="text-gray-700 text-xs">${record.descricaoAvaria}</p>
                                    </div>
                                ` : ''}
                            </div>

                            <button
                                onclick="loadRecordForEdit('${record.id}')"
                                class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2"
                            >
                                <i class="ph ph-pencil-simple"></i>
                                EDITAR ORDEM
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // RENDERIZAÇÃO - FORMULÁRIO PRINCIPAL
        // ============================================
        function renderForm() {
            const filteredPlates = getFilteredPlates();
            const availableFailures = state.tipoEquipamento ? FAILURES_BY_TYPE[state.tipoEquipamento] || [] : [];
            const isEditing = state.editingId !== null;

            return `
                <div class="space-y-6">
                    ${isEditing ? `
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i class="ph ph-info text-blue-500 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-blue-800">Modo de Edição</p>
                                    <p class="text-sm text-blue-600">Você está editando a ordem: ${state.editingId}</p>
                                </div>
                            </div>
                            <button 
                                onclick="resetForm()" 
                                class="mt-2 text-sm text-blue-600 underline"
                            >
                                Cancelar e criar nova ordem
                            </button>
                        </div>
                    ` : ''}

                    <!-- CARD 1: EQUIPAMENTO -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-[#1F4E78] mb-4 flex items-center gap-2 border-b pb-2">
                            <i class="ph ph-truck text-xl"></i> Equipamento
                        </h3>
                        
                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide block mb-1">Buscar Placa</label>
                            <div class="relative">
                                <input 
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 pl-10"
                                    placeholder="Digite para filtrar..."
                                    value="${state.searchTerm}"
                                    oninput="state.searchTerm = this.value; render()"
                                />
                                <i class="ph ph-magnifying-glass absolute left-3 top-3.5 text-gray-400 text-lg"></i>
                            </div>
                        </div>

                        <div class="flex flex-col gap-1 mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Selecionar Placa <span class="text-red-500">*</span></label>
                            <select 
                                class="w-full border border-gray-300 bg-white rounded-lg p-3 text-lg font-bold text-gray-900 focus:ring-2 focus:ring-[#1F4E78]"
                                value="${state.placa}"
                                onchange="handlePlacaChange(this.value)"
                            >
                                <option value="" disabled>Selecione a placa...</option>
                                ${filteredPlates.map(p => `
                                    <option value="${p}" ${state.placa === p ? 'selected' : ''}>${p} - ${FLEET_DATA[p]}</option>
                                `).join('')}
                            </select>
                        </div>

                        ${state.tipoEquipamento ? `
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-blue-800 text-sm font-medium flex items-center gap-2">
                                <i class="ph ph-info"></i>
                                ${state.tipoEquipamento}
                            </div>
                        ` : ''}
                    </div>

                    <!-- CARD 2: DETALHES -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-[#1F4E78] mb-4 flex items-center gap-2 border-b pb-2">
                            <i class="ph ph-clipboard-text text-xl"></i> Detalhes
                        </h3>

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Tipo de Manutenção <span class="text-red-500">*</span></label>
                            <select
                                class="w-full border border-gray-300 bg-white rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78]"
                                value="${state.tipoManutencao}"
                                onchange="handleManutencaoChange(this.value)"
                            >
                                <option value="" disabled>Selecione...</option>
                                ${MAINTENANCE_TYPES.map(type => `
                                    <option value="${type}" ${state.tipoManutencao === type ? 'selected' : ''}>${type}</option>
                                `).join('')}
                            </select>
                            ${state.showCustomManutencao ? `
                                <input
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 mt-2 focus:ring-2 focus:ring-[#1F4E78]"
                                    placeholder="Digite o tipo de manutenção..."
                                    value="${state.tipoManutencaoCustom}"
                                    oninput="state.tipoManutencaoCustom = this.value"
                                />
                            ` : ''}
                        </div>

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-2 block">Prioridade <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-2 gap-2">
                                ${PRIORITIES.map(p => `
                                    <button
                                        type="button"
                                        onclick="state.prioridade = '${p}'; render()"
                                        class="py-3 rounded-lg font-bold text-sm border-2 transition-all ${
                                            state.prioridade === p 
                                                ? getPriorityColor(p) + ' scale-95 shadow-inner' 
                                                : 'bg-gray-50 text-gray-500 border-transparent hover:bg-gray-100'
                                        }"
                                    >
                                        ${p}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        ${state.tipoEquipamento ? `
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">
                                    Avaria (${state.tipoEquipamento.split(' ')[1] || 'Geral'}) <span class="text-red-500">*</span>
                                </label>
                                <select
                                    class="w-full border border-gray-300 bg-white rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78]"
                                    value="${state.tipoAvaria}"
                                    onchange="handleAvariaChange(this.value)"
                                >
                                    <option value="" disabled>Selecione...</option>
                                    ${availableFailures.map(failure => `
                                        <option value="${failure}" ${state.tipoAvaria === failure ? 'selected' : ''}>${failure}</option>
                                    `).join('')}
                                </select>
                                ${state.showCustomAvaria ? `
                                    <input
                                        type="text"
                                        class="w-full border border-gray-300 rounded-lg p-3 mt-2 focus:ring-2 focus:ring-[#1F4E78]"
                                        placeholder="Digite o tipo de avaria..."
                                        value="${state.tipoAvariaCustom}"
                                        oninput="state.tipoAvariaCustom = this.value"
                                    />
                                ` : ''}
                            </div>
                        ` : ''}

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Descrição Detalhada <span class="text-red-500">*</span></label>
                            <textarea
                                class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78] resize-none"
                                placeholder="Descreva o problema, ruídos, vazamentos..."
                                rows="4"
                                oninput="state.descricao = this.value"
                            >${state.descricao}</textarea>
                        </div>

                        ${isEditing ? `
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Status da Ordem</label>
                                <select
                                    class="w-full border border-gray-300 bg-white rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78]"
                                    value="${state.statusOrdem}"
                                    onchange="state.statusOrdem = this.value; render()"
                                >
                                    ${STATUS_OPTIONS.map(status => `
                                        <option value="${status}" ${state.statusOrdem === status ? 'selected' : ''}>${status}</option>
                                    `).join('')}
                                </select>
                            </div>
                        ` : ''}

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Foto da Avaria (Opcional)</label>
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="ph ph-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">Toque para capturar</p>
                                </div>
                                <input type="file" class="hidden" accept="image/*" capture="environment" />
                            </label>
                        </div>
                    </div>

                    <!-- CARD 3: EXECUÇÃO -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-[#1F4E78] mb-4 flex items-center gap-2 border-b pb-2">
                            <i class="ph ph-map-pin text-xl"></i> Local & Execução
                        </h3>

                        <div class="relative mb-4">
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Local da Manutenção <span class="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 pr-12 focus:ring-2 focus:ring-[#1F4E78] focus:border-transparent"
                                    placeholder="Ex: Base, Cliente X, Rodovia Y"
                                    value="${state.local}"
                                    oninput="state.local = this.value"
                                />
                            </div>
                            <button 
                                onclick="handleGetLocation()"
                                class="absolute right-2 top-8 p-2 text-[#1F4E78]"
                                title="Usar GPS"
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                <i class="ph ph-crosshair text-2xl ${state.isLoading ? 'animate-spin' : ''}"></i>
                            </button>
                        </div>

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Oficina / Destino <span class="text-red-500">*</span></label>
                            <select
                                class="w-full border border-gray-300 bg-white rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78]"
                                value="${state.oficina}"
                                onchange="handleOficinaChange(this.value)"
                            >
                                <option value="" disabled>Selecione...</option>
                                ${WORKSHOPS.map(workshop => `
                                    <option value="${workshop}" ${state.oficina === workshop ? 'selected' : ''}>${workshop}</option>
                                `).join('')}
                            </select>
                            ${state.showCustomOficina ? `
                                <input
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 mt-2 focus:ring-2 focus:ring-[#1F4E78]"
                                    placeholder="Digite o nome da oficina..."
                                    value="${state.oficinaCustom}"
                                    oninput="state.oficinaCustom = this.value"
                                />
                            ` : ''}
                        </div>

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Responsável (Mecânico) <span class="text-red-500">*</span></label>
                            <input
                                type="text"
                                class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78] focus:border-transparent"
                                placeholder="Nome do mecânico responsável"
                                value="${state.responsavel}"
                                oninput="state.responsavel = this.value"
                            />
                        </div>

                        <div class="mb-4">
                            <label class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-1 block">Observações Extras</label>
                            <textarea
                                class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#1F4E78] resize-none"
                                rows="3"
                                placeholder="Informações adicionais relevantes..."
                                oninput="state.observacoes = this.value"
                            >${state.observacoes}</textarea>
                        </div>
                    </div>

                    <!-- ACTION BUTTON -->
                    <button
                        onclick="handleSubmit()"
                        ${state.isLoading ? 'disabled' : ''}
                        class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-xl mb-8 flex justify-center items-center gap-2 transition-all ${
                            state.isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#1F4E78] hover:bg-[#163a5c] active:scale-95'
                        }"
                    >
                        ${state.isLoading ? `
                            <i class="ph ph-spinner animate-spin text-2xl"></i>
                            ENVIANDO...
                        ` : isEditing ? `
                            ATUALIZAR ORDEM DE MANUTENÇÃO
                            <i class="ph ph-floppy-disk text-xl"></i>
                        ` : `
                            ABRIR ORDEM DE MANUTENÇÃO
                            <i class="ph ph-paper-plane-right text-xl"></i>
                        `}
                    </button>
                </div>
            `;
        }

        // ============================================
        // RENDERIZAÇÃO PRINCIPAL
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else if (state.view === 'success') {
                app.innerHTML = renderSuccess();
            } else {
                // Header + Content
                const isHistory = state.view === 'history';
                app.innerHTML = `
                    <div class="min-h-screen bg-[#F5F5F5] pb-10">
                        <header class="bg-[#1F4E78] text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
                            <div>
                                <h1 class="font-bold text-lg">${isHistory ? 'Histórico' : (state.editingId ? 'Editar Ordem' : 'Nova Manutenção')}</h1>
                                <p class="text-xs opacity-80">Supervisor: ${state.supervisor}</p>
                            </div>
                            <div class="flex gap-3 items-center">
                                ${state.isSyncing ? `
                                    <i class="ph ph-spinner animate-spin text-xl pulse"></i>
                                ` : ''}
                                <button onclick="state.view='${isHistory ? 'form' : 'history'}'; render()" class="p-2 rounded-full hover:bg-white/10">
                                    <i class="ph ${isHistory ? 'ph-plus' : 'ph-clock-counter-clockwise'} text-2xl"></i>
                                </button>
                                <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white/10">
                                    <i class="ph ph-sign-out text-2xl"></i>
                                </button>
                            </div>
                        </header>

                        <main class="p-4 max-w-lg mx-auto">
                            ${isHistory ? renderHistory() : renderForm()}
                        </main>
                    </div>
                `;
            }
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se já tem supervisor logado
            const savedSupervisor = localStorage.getItem('supervisor_name');
            if (savedSupervisor) {
                state.supervisor = savedSupervisor;
                state.view = 'form';
                startAutoSync(); // Inicia sincronização automática
            }
            
            render();
        });

        // Limpa intervalo ao fechar a página
        window.addEventListener('beforeunload', () => {
            stopAutoSync();
        });
    </script>
</body>
</html>
