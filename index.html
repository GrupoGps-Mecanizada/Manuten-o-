<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manutenção Frota</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Ajustes para Print/Screenshot */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-card { break-inside: avoid; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        // ⚠️ MANTENHA SUA URL AQUI
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzC--8soBc2wXA5vViHeHCFM836w9ZZ_ow_oYqmTRKuPqQNd9DhoImcx3DZYlv38jS5NA/exec'; 
        
        const SYNC_INTERVAL = 30000;
        let syncIntervalId = null;

        // ============================================
        // DADOS
        // ============================================
        const FLEET_DATA = {
            "CZC-0453": "CAMINHÃO ALTA PRESSÃO", "DSY6472": "CAMINHÃO ALTA PRESSÃO",
            "DSY6474": "CAMINHÃO ALTA PRESSÃO", "DSY6475": "CAMINHÃO ALTA PRESSÃO",
            "DSY6F81": "CAMINHÃO ALTA PRESSÃO", "EAM-3253": "CAMINHÃO ALTA PRESSÃO",
            "EAM3255": "CAMINHÃO ALTA PRESSÃO", "EAM3256": "CAMINHÃO ALTA PRESSÃO",
            "EAM3262": "CAMINHÃO ALTA PRESSÃO", "EGC2978": "CAMINHÃO ALTA PRESSÃO",
            "EGC2983": "CAMINHÃO ALTA PRESSÃO", "EGC2985": "CAMINHÃO ALTA PRESSÃO",
            "EGC2989": "CAMINHÃO ALTA PRESSÃO", "EZS8764": "CAMINHÃO ALTA PRESSÃO",
            "LUX-3201": "CAMINHÃO ALTA PRESSÃO", "PUB2F80": "CAMINHÃO ALTA PRESSÃO",
            "ALY5322": "CAMINHÃO AUTO VÁCUO", "ANF-2676": "CAMINHÃO AUTO VÁCUO",
            "CUB0763": "CAMINHÃO AUTO VÁCUO", "DSY6473": "CAMINHÃO AUTO VÁCUO",
            "DSY6577": "CAMINHÃO AUTO VÁCUO", "DYB7210": "CAMINHÃO AUTO VÁCUO",
            "EAM3251": "CAMINHÃO AUTO VÁCUO", "EAM3257": "CAMINHÃO AUTO VÁCUO",
            "EGC2993": "CAMINHÃO AUTO VÁCUO", "FSA3D71": "CAMINHÃO AUTO VÁCUO",
            "HJS1097": "CAMINHÃO AUTO VÁCUO", "DSY6477": "CAMINHÃO BROOK",
            "EGC-2984": "CAMINHÃO BROOK", "EPN2463": "CAMINHÃO BROOK",
            "HKH2H79": "CAMINHÃO BROOK", "DSY6471": "CAMINHÃO HIPER VÁCUO",
            "FHD9264": "CAMINHÃO HIPER VÁCUO", "FMD2200": "CAMINHÃO HIPER VÁCUO",
            "ASP02": "ASPIRADOR", "ASP04": "ASPIRADOR", "ASP06": "ASPIRADOR",
            "ASP07": "ASPIRADOR", "ASP08": "ASPIRADOR", "ASP09": "ASPIRADOR",
            "ASP10": "ASPIRADOR", "ASP12": "ASPIRADOR", "ASP12-RESERVA": "ASPIRADOR",
            "ASPII": "ASPIRADOR"
        };

        const MAINTENANCE_TYPES = ["Preventiva", "Corretiva", "Preditiva", "Emergencial", "Outro"];
        const WORKSHOPS = ["SERVITEC", "PARANA MOLAS", "BORRACHARIA", "Outro"];
        
        const FAILURES_BY_TYPE = {
            "CAMINHÃO ALTA PRESSÃO": ["Bomba Alta Pressão", "Mangueira Alta Pressão", "Bico Rotativo", "Motor Bomba", "Sistema Hidráulico", "Válvulas de Pressão", "Filtros Bomba", "Tanque de Água", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO AUTO VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO HIPER VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO BROOK": ["Sistema de Desobstrução", "Lança/Braço Mecânico", "Mangueiras", "Sistema Hidráulico", "Cabos de Aço", "Filtros", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "ASPIRADOR": ["Motor de Sucção", "Filtros", "Mangueiras", "Sistema Elétrico", "Tanque", "Outro"]
        };

        // ============================================
        // ESTADO
        // ============================================
        let state = {
            view: 'login',
            supervisor: '',
            editingId: null,
            closingId: null,
            placa: '',
            tipoEquipamento: '',
            tipoManutencao: '',
            tipoManutencaoCustom: '',
            tipoAvaria: '',
            tipoAvariaCustom: '',
            descricao: '',
            oficina: '',
            oficinaCustom: '',
            observacoes: '',
            dataHoraAvaria: '',
            dataHoraFechamento: '',
            statusFechamento: '',
            statusOrdem: 'Aberta',
            isLoading: false,
            isSyncing: false,
            showCustomManutencao: false,
            showCustomOficina: false,
            showCustomAvaria: false
        };

        // ============================================
        // SERVIÇOS & SYNC
        // ============================================
        async function submitToSheet(record) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify(record)
                });
                const data = await response.json();
                return { success: data.success, message: data.error };
            } catch (error) {
                console.error('Erro rede:', error);
                return { success: false, message: error.message };
            }
        }

        async function fetchFromSheet() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET', redirect: 'follow' });
                const data = await response.json();
                if (data.success && data.records) {
                    localStorage.setItem('maintenance_history', JSON.stringify(data.records));
                    return true;
                }
                return false;
            } catch (error) { return false; }
        }

        async function syncWithSheet() {
            if (state.isSyncing) return;
            state.isSyncing = true;
            render(); 
            const history = getMaintenanceHistory();
            const pending = history.filter(r => r.status === 'pending');
            for (const record of pending) {
                const result = await submitToSheet(record);
                if (result.success) updateHistoryStatus(record.id, 'synced');
            }
            await fetchFromSheet();
            state.isSyncing = false;
            render();
        }

        // ============================================
        // UTILITÁRIOS (DATA & TEMPO)
        // ============================================
        function getMaintenanceHistory() {
            return JSON.parse(localStorage.getItem('maintenance_history') || '[]');
        }

        function saveToHistory(record) {
            const history = getMaintenanceHistory();
            const idx = history.findIndex(r => r.id === record.id);
            if (idx !== -1) history[idx] = record;
            else history.unshift(record);
            localStorage.setItem('maintenance_history', JSON.stringify(history));
        }

        function updateHistoryStatus(id, status) {
            const history = getMaintenanceHistory();
            const item = history.find(r => r.id === id);
            if (item) {
                item.status = status;
                localStorage.setItem('maintenance_history', JSON.stringify(history));
            }
        }

        function formatDateTimeLocal(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return '';
            const offsetMs = date.getTimezoneOffset() * 60 * 1000;
            return new Date(date.getTime() - offsetMs).toISOString().slice(0, 16);
        }

        function formatDisplayDate(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            return isNaN(date.getTime()) ? isoDate : date.toLocaleString('pt-BR', { 
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        }

        // --- NOVA FUNÇÃO DE CÁLCULO DE TEMPO ---
        function calculateDuration(start, end) {
            if (!start) return '-';
            if (!end) return 'Em andamento...';
            
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            if (isNaN(startDate) || isNaN(endDate)) return '-';

            const diffMs = endDate - startDate;
            if (diffMs < 0) return 'Data Inválida';

            const minutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            const remHours = hours % 24;
            const remMin = minutes % 60;

            if (days > 0) return `${days}d ${remHours}h ${remMin}m`;
            if (hours > 0) return `${hours}h ${remMin}m`;
            return `${remMin} min`;
        }

        // ============================================
        // LOGICA DE INTERFACE
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            if (!state.supervisor.trim()) return;
            localStorage.setItem('supervisor_name', state.supervisor);
            state.view = 'form';
            startAutoSync();
            render();
        }

        function handleLogout() {
            if (syncIntervalId) clearInterval(syncIntervalId);
            localStorage.removeItem('supervisor_name');
            state.supervisor = '';
            state.view = 'login';
            render();
        }

        function startAutoSync() {
            if (syncIntervalId) clearInterval(syncIntervalId);
            syncIntervalId = setInterval(syncWithSheet, SYNC_INTERVAL);
            syncWithSheet();
        }

        async function handleSubmit() {
            const { placa, tipoManutencao, tipoManutencaoCustom, tipoAvaria, tipoAvariaCustom, 
                    descricao, oficina, oficinaCustom, dataHoraAvaria } = state;
            
            if (!placa || !descricao || !dataHoraAvaria) {
                alert("Preencha campos com *");
                return;
            }

            const finalManutencao = tipoManutencao === 'Outro' ? tipoManutencaoCustom.trim() : tipoManutencao;
            const finalOficina = oficina === 'Outro' ? oficinaCustom.trim() : oficina;
            const finalAvaria = tipoAvaria === 'Outro' ? tipoAvariaCustom.trim() : tipoAvaria;

            if (!finalManutencao || !finalOficina || !finalAvaria) {
                alert("Preencha os campos 'Outro' corretamente.");
                return;
            }

            state.isLoading = true;
            render();

            const record = {
                id: state.editingId || `ORD-${Date.now()}`,
                dataHoraAbertura: state.editingId ? state.dataHoraAbertura : new Date().toISOString(),
                dataHoraAvaria: new Date(dataHoraAvaria).toISOString(),
                dataHoraFechamento: state.dataHoraFechamento ? new Date(state.dataHoraFechamento).toISOString() : null,
                supervisor: state.supervisor,
                placa,
                tipoEquipamento: state.tipoEquipamento,
                tipoManutencao: finalManutencao,
                tipoAvaria: finalAvaria,
                descricaoAvaria: descricao.trim(),
                oficina: finalOficina,
                observacoes: state.observacoes.trim(),
                statusOrdem: state.statusOrdem,
                status: 'pending'
            };

            saveToHistory(record);
            const result = await submitToSheet(record);
            state.isLoading = false;
            if (result.success) updateHistoryStatus(record.id, 'synced');
            state.view = 'success';
            state.editingId = null;
            render();
        }

        function loadRecordForClose(id) {
            const r = getMaintenanceHistory().find(x => x.id === id);
            if (!r) return;
            state.closingId = id;
            const now = new Date();
            const offsetMs = now.getTimezoneOffset() * 60 * 1000;
            state.dataHoraFechamento = new Date(now.getTime() - offsetMs).toISOString().slice(0, 16);
            state.statusFechamento = '';
            state.view = 'close';
            render();
        }

        async function handleCloseOrder() {
            if (!state.dataHoraFechamento || !state.statusFechamento) {
                alert('Informe data e status.');
                return;
            }
            state.isLoading = true;
            render();
            const history = getMaintenanceHistory();
            const record = history.find(r => r.id === state.closingId);
            if (record) {
                record.dataHoraFechamento = new Date(state.dataHoraFechamento).toISOString();
                record.statusOrdem = `Manutenção ${state.statusFechamento}`;
                record.status = 'pending';
                saveToHistory(record);
                const result = await submitToSheet(record);
                if (result.success) updateHistoryStatus(record.id, 'synced');
            }
            state.isLoading = false;
            state.closingId = null;
            state.statusFechamento = '';
            state.view = 'success';
            render();
        }

        function loadRecordForEdit(id) {
            const r = getMaintenanceHistory().find(x => x.id === id);
            if (!r) return;
            state.editingId = r.id;
            state.placa = r.placa;
            state.tipoEquipamento = r.tipoEquipamento;
            state.dataHoraAbertura = r.dataHoraAbertura;
            state.dataHoraAvaria = formatDateTimeLocal(r.dataHoraAvaria);
            state.descricao = r.descricaoAvaria;
            state.observacoes = r.observacoes || '';
            state.statusOrdem = r.statusOrdem;
            
            if (MAINTENANCE_TYPES.includes(r.tipoManutencao)) {
                state.tipoManutencao = r.tipoManutencao;
                state.showCustomManutencao = false;
            } else {
                state.tipoManutencao = 'Outro';
                state.tipoManutencaoCustom = r.tipoManutencao;
                state.showCustomManutencao = true;
            }
            if (WORKSHOPS.includes(r.oficina)) {
                state.oficina = r.oficina;
                state.showCustomOficina = false;
            } else {
                state.oficina = 'Outro';
                state.oficinaCustom = r.oficina;
                state.showCustomOficina = true;
            }
            const failures = FAILURES_BY_TYPE[r.tipoEquipamento] || [];
            if (failures.includes(r.tipoAvaria)) {
                state.tipoAvaria = r.tipoAvaria;
                state.showCustomAvaria = false;
            } else {
                state.tipoAvaria = 'Outro';
                state.tipoAvariaCustom = r.tipoAvaria;
                state.showCustomAvaria = true;
            }
            state.view = 'form';
            render();
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            let content = '';
            let title = '';

            switch (state.view) {
                case 'login': return app.innerHTML = renderLogin();
                case 'success': return app.innerHTML = renderSuccess();
                case 'close': 
                    content = renderCloseOrder();
                    title = 'Finalizar Ordem';
                    break;
                case 'history':
                    content = renderHistory();
                    title = 'Histórico Detalhado';
                    break;
                default:
                    content = renderForm();
                    title = state.editingId ? 'Editar Ordem' : 'Nova Manutenção';
            }
            
            app.innerHTML = `
                <div class="min-h-screen bg-[#F5F5F5] pb-10">
                    <header class="bg-[#1F4E78] text-white p-4 sticky top-0 z-30 shadow-md flex justify-between items-center no-print">
                        <div>
                            <h1 class="font-bold text-lg">${title}</h1>
                            <p class="text-xs opacity-80 uppercase">${state.supervisor}</p>
                        </div>
                        <div class="flex gap-3 items-center">
                            ${state.isSyncing ? '<i class="ph ph-spinner animate-spin text-xl"></i>' : ''}
                            <button onclick="state.view='${state.view === 'history' ? 'form' : 'history'}'; render()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ${state.view === 'history' ? 'ph-plus' : 'ph-clock-counter-clockwise'} text-2xl"></i>
                            </button>
                            <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ph-sign-out text-2xl"></i>
                            </button>
                        </div>
                    </header>
                    <main class="p-4 max-w-2xl mx-auto">${content}</main>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-[#1F4E78]">
                    <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div class="flex justify-center mb-6 text-[#1F4E78]"><i class="ph ph-wrench text-6xl"></i></div>
                        <h1 class="text-2xl font-bold text-center text-gray-800 mb-8">Manutenção Frota</h1>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-6">
                                <label class="text-sm font-bold text-gray-700 block mb-2">NOME DO SUPERVISOR</label>
                                <input type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-[#1F4E78] outline-none"
                                    value="${state.supervisor}" oninput="state.supervisor = this.value" required placeholder="Digite seu nome">
                            </div>
                            <button type="submit" class="w-full bg-[#70AD47] text-white font-bold py-4 rounded-xl shadow-lg">ENTRAR</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderForm() {
            const allPlates = Object.keys(FLEET_DATA);
            const failures = state.tipoEquipamento ? FAILURES_BY_TYPE[state.tipoEquipamento] || [] : [];
            return `
                <div class="space-y-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-truck text-xl"></i> Equipamento
                        </h3>
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Selecione a Placa *</label>
                            <select class="w-full border-2 border-gray-200 rounded-lg p-4 font-bold text-gray-800 focus:border-[#1F4E78] bg-white"
                                onchange="state.placa = this.value; state.tipoEquipamento = FLEET_DATA[this.value]; state.tipoAvaria=''; render()">
                                <option value="" disabled ${!state.placa ? 'selected' : ''}>Toque para selecionar...</option>
                                ${allPlates.map(p => `<option value="${p}" ${state.placa === p ? 'selected' : ''}>${p} - ${FLEET_DATA[p]}</option>`).join('')}
                            </select>
                        </div>
                        ${state.tipoEquipamento ? `<div class="mt-2 text-sm text-blue-800 bg-blue-50 p-3 rounded-lg flex items-center gap-2 border border-blue-100"><i class="ph ph-info text-lg"></i><span class="font-semibold">${state.tipoEquipamento}</span></div>` : ''}
                    </div>

                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-clipboard-text text-xl"></i> Detalhes da Avaria
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Data/Hora da Avaria *</label>
                            <input type="datetime-local" class="w-full border border-gray-300 rounded-lg p-3" value="${state.dataHoraAvaria}" oninput="state.dataHoraAvaria = this.value">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Tipo de Manutenção *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white" onchange="state.tipoManutencao = this.value; state.showCustomManutencao = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.tipoManutencao ? 'selected' : ''}>Selecione...</option>
                                ${MAINTENANCE_TYPES.map(t => `<option value="${t}" ${state.tipoManutencao === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                            ${state.showCustomManutencao ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Especifique..." value="${state.tipoManutencaoCustom}" oninput="state.tipoManutencaoCustom = this.value">` : ''}
                        </div>
                        ${state.tipoEquipamento ? `<div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Componente/Falha *</label><select class="w-full border border-gray-300 rounded-lg p-3 bg-white" onchange="state.tipoAvaria = this.value; state.showCustomAvaria = (this.value === 'Outro'); render()"><option value="" disabled ${!state.tipoAvaria ? 'selected' : ''}>Selecione...</option>${failures.map(f => `<option value="${f}" ${state.tipoAvaria === f ? 'selected' : ''}>${f}</option>`).join('')}</select>${state.showCustomAvaria ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Especifique..." value="${state.tipoAvariaCustom}" oninput="state.tipoAvariaCustom = this.value">` : ''}</div>` : ''}
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Descrição Detalhada *</label>
                            <textarea class="w-full border border-gray-300 rounded-lg p-3 h-24 resize-none" placeholder="Descreva o problema..." oninput="state.descricao = this.value">${state.descricao}</textarea>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-wrench text-xl"></i> Execução
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Oficina / Destino *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white" onchange="state.oficina = this.value; state.showCustomOficina = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.oficina ? 'selected' : ''}>Selecione...</option>
                                ${WORKSHOPS.map(w => `<option value="${w}" ${state.oficina === w ? 'selected' : ''}>${w}</option>`).join('')}
                            </select>
                            ${state.showCustomOficina ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Nome da oficina..." value="${state.oficinaCustom}" oninput="state.oficinaCustom = this.value">` : ''}
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Observações (Opcional)</label>
                            <input type="text" class="w-full border border-gray-300 rounded-lg p-3" placeholder="..." value="${state.observacoes}" oninput="state.observacoes = this.value">
                        </div>
                    </div>

                    <button onclick="handleSubmit()" ${state.isLoading ? 'disabled' : ''} class="w-full py-4 rounded-xl text-white font-bold shadow-lg flex justify-center items-center gap-2 ${state.isLoading ? 'bg-gray-400' : 'bg-[#1F4E78] active:scale-95'}">
                        ${state.isLoading ? '<i class="ph ph-spinner animate-spin text-2xl"></i> PROCESSANDO...' : (state.editingId ? 'ATUALIZAR ORDEM' : 'ABRIR ORDEM')}
                    </button>
                    ${state.editingId ? `<button onclick="resetForm()" class="w-full py-3 text-gray-500 font-bold">CANCELAR EDIÇÃO</button>` : ''}
                </div>
            `;
        }

        function renderCloseOrder() {
            const r = getMaintenanceHistory().find(x => x.id === state.closingId);
            if(!r) return 'Erro de registro';
            
            // Calculo dinamico para exibir enquanto escolhe a data
            const duracaoAtual = calculateDuration(r.dataHoraAvaria, state.dataHoraFechamento);

            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="font-bold text-xl text-gray-800">${r.placa}</h3>
                        <p class="text-sm text-gray-500">${r.tipoAvaria}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Data/Hora de Retorno *</label>
                        <input type="datetime-local" class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-[#1F4E78]"
                            value="${state.dataHoraFechamento}" oninput="state.dataHoraFechamento = this.value; render()">
                        
                        <!-- Mostra o tempo calculado ao vivo -->
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center justify-between">
                            <span class="text-xs font-bold text-blue-800 uppercase">Tempo Calculado:</span>
                            <span class="font-bold text-blue-900">${duracaoAtual}</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3 text-center">AVALIAÇÃO DA MANUTENÇÃO *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="state.statusFechamento='Aprovada'; render()"
                                class="p-6 rounded-xl border-4 transition-all flex flex-col items-center gap-2 shadow-sm ${state.statusFechamento === 'Aprovada' ? 'bg-green-50 border-green-500 text-green-700 scale-105' : 'border-gray-100 text-gray-400 hover:border-green-200'}">
                                <i class="ph ph-check-circle text-4xl"></i><span class="font-bold uppercase">Aprovada</span>
                            </button>
                            <button onclick="state.statusFechamento='Reprovada'; render()"
                                class="p-6 rounded-xl border-4 transition-all flex flex-col items-center gap-2 shadow-sm ${state.statusFechamento === 'Reprovada' ? 'bg-red-50 border-red-500 text-red-700 scale-105' : 'border-gray-100 text-gray-400 hover:border-red-200'}">
                                <i class="ph ph-x-circle text-4xl"></i><span class="font-bold uppercase">Reprovada</span>
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 space-y-3">
                        <button onclick="handleCloseOrder()" class="w-full bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg">CONFIRMAR E FECHAR</button>
                        <button onclick="state.view='history'; state.closingId=null; render()" class="w-full text-gray-500 font-bold py-3">CANCELAR</button>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            const records = getMaintenanceHistory();
            if (!records.length) return `<div class="text-center py-12 text-gray-400"><i class="ph ph-files text-4xl mb-2"></i><p>Nenhum registro</p></div>`;

            return `
                <div class="space-y-6">
                    ${records.map(r => {
                        const duration = calculateDuration(r.dataHoraAvaria, r.dataHoraFechamento);
                        return `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 print-card">
                            <div class="p-3 text-white flex justify-between items-center ${r.statusOrdem.includes('Aprovada') ? 'bg-green-600' : r.statusOrdem.includes('Reprovada') ? 'bg-red-600' : r.statusOrdem === 'Aberta' ? 'bg-[#1F4E78]' : 'bg-gray-500'}">
                                <div>
                                    <h3 class="font-bold text-lg leading-tight">${r.placa}</h3>
                                    <p class="text-xs opacity-90">${r.tipoEquipamento}</p>
                                </div>
                                <div class="text-right">
                                    <span class="block text-xs font-bold uppercase tracking-wider">${r.statusOrdem}</span>
                                    <span class="text-[10px] opacity-75">ID: ${r.id.slice(-6)}</span>
                                </div>
                            </div>
                            <div class="p-4 text-sm text-gray-700 space-y-3">
                                <div class="grid grid-cols-2 gap-2 border-b border-gray-100 pb-2">
                                    <div><span class="block text-xs text-gray-400 font-bold uppercase">Saída/Avaria</span><span class="font-semibold text-gray-800">${formatDisplayDate(r.dataHoraAvaria)}</span></div>
                                    <div><span class="block text-xs text-gray-400 font-bold uppercase">Retorno</span><span class="font-semibold text-gray-800">${formatDisplayDate(r.dataHoraFechamento)}</span></div>
                                </div>

                                <!-- NOVA ÁREA: TEMPO TOTAL -->
                                <div class="bg-gray-100 rounded-lg p-2 text-center border border-gray-200">
                                    <span class="block text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-1">⏱️ Tempo Total em Manutenção</span>
                                    <div class="font-black text-lg text-gray-800">${duration}</div>
                                </div>

                                <div><span class="block text-xs text-gray-400 font-bold uppercase">Falha Informada</span><div class="font-bold text-red-600">${r.tipoAvaria}</div></div>
                                <div class="bg-gray-50 p-2 rounded border border-gray-100"><span class="block text-xs text-gray-400 font-bold uppercase mb-1">Descrição do Problema</span><p class="italic text-gray-600 leading-snug">"${r.descricaoAvaria}"</p></div>
                                <div class="grid grid-cols-2 gap-2 pt-1">
                                    <div><span class="block text-xs text-gray-400 font-bold uppercase">Oficina</span><span class="font-medium">${r.oficina}</span></div>
                                    <div><span class="block text-xs text-gray-400 font-bold uppercase">Supervisor</span><span class="font-medium">${r.supervisor}</span></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 flex gap-2 border-t border-gray-100 no-print">
                                <button onclick="loadRecordForEdit('${r.id}')" class="flex-1 py-2 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600">EDITAR</button>
                                ${!r.statusOrdem.includes('Manutenção') ? `<button onclick="loadRecordForClose('${r.id}')" class="flex-1 py-2 bg-[#1F4E78] text-white rounded text-xs font-bold shadow-sm">FECHAR ORDEM</button>` : ''}
                            </div>
                        </div>
                    `}).join('')}
                    <div class="text-center pt-4 no-print"><button onclick="if(confirm('Limpar dados locais?')) { localStorage.removeItem('maintenance_history'); render(); }" class="text-red-300 text-xs underline">Limpar Cache</button></div>
                </div>
            `;
        }

        function renderSuccess() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 animate-bounce"><i class="ph ph-check text-4xl"></i></div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h2>
                    <p class="text-gray-500 mb-8">Operação registrada e sincronizada.</p>
                    <button onclick="resetForm()" class="w-full bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg mb-4">NOVA ORDEM</button>
                    <button onclick="state.view='history'; render()" class="w-full border-2 border-gray-200 font-bold py-4 rounded-xl text-gray-600">VER HISTÓRICO</button>
                </div>
            `;
        }

        function resetForm() {
            state.editingId = null;
            state.closingId = null;
            state.placa = '';
            state.tipoEquipamento = '';
            state.tipoManutencao = '';
            state.tipoManutencaoCustom = '';
            state.tipoAvaria = '';
            state.tipoAvariaCustom = '';
            state.descricao = '';
            state.oficina = '';
            state.oficinaCustom = '';
            state.observacoes = '';
            state.dataHoraAvaria = '';
            state.statusOrdem = 'Aberta';
            state.showCustomManutencao = false;
            state.showCustomOficina = false;
            state.showCustomAvaria = false;
            state.view = 'form';
            render();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedSupervisor = localStorage.getItem('supervisor_name');
            if (savedSupervisor) {
                state.supervisor = savedSupervisor;
                state.view = 'form';
                startAutoSync();
            }
            render();
        });
        window.addEventListener('beforeunload', () => clearInterval(syncIntervalId));
    </script>
</body>
</html>
