<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manutenção Frota</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS (Versão Play CDN mais estável para protótipos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        // ⚠️ IMPORTANTE: Substitua pela URL da NOVA IMPLANTAÇÃO ("Anyone")
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyk2klqMJdVpsjcBzDJhl6zulcIO-f2hwjQFwOPvqwS1d2IQZqHUt3em48QSewKKZxTvg/exec'; 
        
        const SYNC_INTERVAL = 30000;
        let syncIntervalId = null;
        let lastSyncTime = null;

        // ============================================
        // DADOS DA FROTA
        // ============================================
        const FLEET_DATA = {
            "CZC-0453": "CAMINHÃO ALTA PRESSÃO", "DSY6472": "CAMINHÃO ALTA PRESSÃO",
            "DSY6474": "CAMINHÃO ALTA PRESSÃO", "DSY6475": "CAMINHÃO ALTA PRESSÃO",
            "DSY6F81": "CAMINHÃO ALTA PRESSÃO", "EAM-3253": "CAMINHÃO ALTA PRESSÃO",
            "EAM3255": "CAMINHÃO ALTA PRESSÃO", "EAM3256": "CAMINHÃO ALTA PRESSÃO",
            "EAM3262": "CAMINHÃO ALTA PRESSÃO", "EGC2978": "CAMINHÃO ALTA PRESSÃO",
            "EGC2983": "CAMINHÃO ALTA PRESSÃO", "EGC2985": "CAMINHÃO ALTA PRESSÃO",
            "EGC2989": "CAMINHÃO ALTA PRESSÃO", "EZS8764": "CAMINHÃO ALTA PRESSÃO",
            "LUX-3201": "CAMINHÃO ALTA PRESSÃO", "PUB2F80": "CAMINHÃO ALTA PRESSÃO",
            "ALY5322": "CAMINHÃO AUTO VÁCUO", "ANF-2676": "CAMINHÃO AUTO VÁCUO",
            "CUB0763": "CAMINHÃO AUTO VÁCUO", "DSY6473": "CAMINHÃO AUTO VÁCUO",
            "DSY6577": "CAMINHÃO AUTO VÁCUO", "DYB7210": "CAMINHÃO AUTO VÁCUO",
            "EAM3251": "CAMINHÃO AUTO VÁCUO", "EAM3257": "CAMINHÃO AUTO VÁCUO",
            "EGC2993": "CAMINHÃO AUTO VÁCUO", "FSA3D71": "CAMINHÃO AUTO VÁCUO",
            "HJS1097": "CAMINHÃO AUTO VÁCUO", "DSY6477": "CAMINHÃO BROOK",
            "EGC-2984": "CAMINHÃO BROOK", "EPN2463": "CAMINHÃO BROOK",
            "HKH2H79": "CAMINHÃO BROOK", "DSY6471": "CAMINHÃO HIPER VÁCUO",
            "FHD9264": "CAMINHÃO HIPER VÁCUO", "FMD2200": "CAMINHÃO HIPER VÁCUO",
            "ASP02": "ASPIRADOR", "ASP04": "ASPIRADOR", "ASP06": "ASPIRADOR",
            "ASP07": "ASPIRADOR", "ASP08": "ASPIRADOR", "ASP09": "ASPIRADOR",
            "ASP10": "ASPIRADOR", "ASP12": "ASPIRADOR", "ASP12-RESERVA": "ASPIRADOR",
            "ASPII": "ASPIRADOR"
        };

        const MAINTENANCE_TYPES = ["Preventiva", "Corretiva", "Preditiva", "Emergencial", "Outro"];
        const WORKSHOPS = ["Oficina Interna", "Oficina Externa - A definir", "Mecânica Diesel", "Especializada Bomba", "Especializada Hidráulica", "Concessionária", "Em Campo (Emergencial)", "Outro"];
        const FAILURES_BY_TYPE = {
            "CAMINHÃO ALTA PRESSÃO": ["Bomba Alta Pressão", "Mangueira Alta Pressão", "Bico Rotativo", "Motor Bomba", "Sistema Hidráulico", "Válvulas de Pressão", "Filtros Bomba", "Tanque de Água", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO AUTO VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO HIPER VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO BROOK": ["Sistema de Desobstrução", "Lança/Braço Mecânico", "Mangueiras", "Sistema Hidráulico", "Cabos de Aço", "Filtros", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "ASPIRADOR": ["Motor de Sucção", "Filtros", "Mangueiras", "Sistema Elétrico", "Tanque", "Outro"]
        };
        const PRIORITIES = ["URGENTE", "ALTA", "MEDIA", "BAIXA"];
        const STATUS_OPTIONS = ["Aberta", "Em Andamento", "Aguardando Peças", "Concluída", "Cancelada"];

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let state = {
            view: 'login',
            supervisor: '',
            editingId: null,
            closingId: null,
            placa: '',
            tipoEquipamento: '',
            tipoManutencao: '',
            tipoManutencaoCustom: '',
            prioridade: '',
            tipoAvaria: '',
            tipoAvariaCustom: '',
            descricao: '',
            local: '',
            oficina: '',
            oficinaCustom: '',
            responsavel: '',
            observacoes: '',
            statusOrdem: 'Aberta',
            dataHoraAvaria: '',
            dataHoraFechamento: '',
            searchTerm: '',
            isLoading: false,
            isSyncing: false,
            historyFilter: 'all',
            showCustomManutencao: false,
            showCustomOficina: false,
            showCustomAvaria: false
        };

        // ============================================
        // INTEGRAÇÃO GOOGLE SHEETS (CORRIGIDA)
        // ============================================
        
        async function submitToSheet(record) {
            try {
                // CORREÇÃO CRÍTICA: Não usar 'Content-Type': 'application/json'
                // O Google Scripts lida melhor com text/plain para evitar Preflight CORS
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow', // Seguir redirecionamentos do Google
                    body: JSON.stringify(record) // Envia como string pura
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Sucesso ao enviar:', data);
                    return { success: true };
                } else {
                    throw new Error(data.error || 'Erro desconhecido no servidor');
                }
            } catch (error) {
                console.error('Erro ao enviar para Google Sheets:', error);
                return { success: false, message: error.message };
            }
        }

        async function fetchFromSheet() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const data = await response.json();
                
                if (data.success && data.records) {
                    // Atualiza apenas se houver sucesso
                    localStorage.setItem('maintenance_history', JSON.stringify(data.records));
                    lastSyncTime = new Date();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Erro ao buscar do Google Sheets:', error);
                return false;
            }
        }

        async function syncWithSheet() {
            if (state.isSyncing) return;
            
            state.isSyncing = true;
            render(); // Atualiza UI para mostrar spinner
            
            // 1. Enviar pendentes
            const history = getMaintenanceHistory();
            const pending = history.filter(r => r.status === 'pending');
            
            if (pending.length > 0) {
                console.log(`Enviando ${pending.length} registros pendentes...`);
                for (const record of pending) {
                    const result = await submitToSheet(record);
                    if (result.success) {
                        updateHistoryStatus(record.id, 'synced');
                    }
                }
            }

            // 2. Buscar atualizações
            await fetchFromSheet();
            
            state.isSyncing = false;
            render();
        }

        // ============================================
        // FUNÇÕES DE UTILIDADE
        // ============================================
        function getMaintenanceHistory() {
            const history = localStorage.getItem('maintenance_history');
            return history ? JSON.parse(history) : [];
        }

        function saveToHistory(record) {
            const history = getMaintenanceHistory();
            const existingIndex = history.findIndex(r => r.id === record.id);
            if (existingIndex !== -1) {
                history[existingIndex] = record;
            } else {
                history.unshift(record);
            }
            localStorage.setItem('maintenance_history', JSON.stringify(history));
        }

        function updateHistoryStatus(id, status) {
            const history = getMaintenanceHistory();
            const index = history.findIndex(r => r.id === id);
            if (index !== -1) {
                history[index].status = status;
                localStorage.setItem('maintenance_history', JSON.stringify(history));
            }
        }

        function formatDateTimeLocal(isoString) {
            if (!isoString) return '';
            // Tenta converter ISO string para formato datetime-local (YYYY-MM-DDThh:mm)
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return '';
            
            // Ajuste fuso horário manual para input local
            const offsetMs = date.getTimezoneOffset() * 60 * 1000;
            const msLocal = date.getTime() - offsetMs;
            const dateLocal = new Date(msLocal);
            const iso = dateLocal.toISOString();
            return iso.slice(0, 16);
        }

        function formatDate(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            if (isNaN(date.getTime())) return isoDate;
            return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // ============================================
        // HANDLERS
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            if (!state.supervisor.trim()) return;
            localStorage.setItem('supervisor_name', state.supervisor);
            state.view = 'form';
            startAutoSync();
            render();
        }

        function handleLogout() {
            stopAutoSync();
            localStorage.removeItem('supervisor_name');
            state.supervisor = '';
            state.view = 'login';
            render();
        }

        async function handleSubmit() {
            const { placa, tipoManutencao, tipoManutencaoCustom, prioridade, tipoAvaria, 
                    tipoAvariaCustom, descricao, local, oficina, oficinaCustom, responsavel, dataHoraAvaria } = state;
            
            if (!placa || !prioridade || !descricao || !local || !responsavel || !dataHoraAvaria) {
                alert("Por favor, preencha todos os campos obrigatórios marcados com *");
                return;
            }

            const finalManutencao = tipoManutencao === 'Outro' ? tipoManutencaoCustom.trim() : tipoManutencao;
            const finalOficina = oficina === 'Outro' ? oficinaCustom.trim() : oficina;
            const finalAvaria = tipoAvaria === 'Outro' ? tipoAvariaCustom.trim() : tipoAvaria;

            if (!finalManutencao || !finalOficina || !finalAvaria) {
                alert("Por favor, preencha todos os campos customizados.");
                return;
            }

            state.isLoading = true;
            render();

            const recordId = state.editingId || `ORD-${Date.now()}`;
            const now = new Date().toISOString();

            const newRecord = {
                id: recordId,
                dataHoraAbertura: state.editingId ? state.dataHoraAbertura : now,
                dataHoraAvaria: new Date(state.dataHoraAvaria).toISOString(),
                dataHoraFechamento: state.dataHoraFechamento ? new Date(state.dataHoraFechamento).toISOString() : null,
                supervisor: state.supervisor,
                placa: state.placa,
                tipoEquipamento: state.tipoEquipamento,
                tipoManutencao: finalManutencao,
                prioridade: state.prioridade,
                tipoAvaria: finalAvaria,
                descricaoAvaria: state.descricao.trim(),
                localManutencao: state.local.trim(),
                oficina: finalOficina,
                responsavelManutencao: state.responsavel.trim(),
                observacoes: state.observacoes.trim(),
                statusOrdem: state.statusOrdem,
                status: 'pending' // Inicialmente pendente
            };

            // 1. Salva localmente primeiro
            saveToHistory(newRecord);

            // 2. Tenta enviar
            const result = await submitToSheet(newRecord);

            state.isLoading = false;

            if (result.success) {
                updateHistoryStatus(newRecord.id, 'synced');
            } else {
                alert("Salvo localmente. Será sincronizado quando houver conexão.");
            }

            state.view = 'success';
            state.editingId = null;
            render();
        }

        async function handleCloseOrder() {
            if (!state.dataHoraFechamento) {
                alert('Informe a data/hora de retorno.');
                return;
            }

            state.isLoading = true;
            render();

            const history = getMaintenanceHistory();
            const record = history.find(r => r.id === state.closingId);

            if (record) {
                record.dataHoraFechamento = new Date(state.dataHoraFechamento).toISOString();
                record.statusOrdem = 'Concluída';
                record.status = 'pending';
                
                saveToHistory(record);
                const result = await submitToSheet(record);
                
                if (result.success) {
                    updateHistoryStatus(record.id, 'synced');
                }
            }

            state.isLoading = false;
            state.closingId = null;
            state.dataHoraFechamento = '';
            state.view = 'success';
            render();
        }

        function startAutoSync() {
            if (syncIntervalId) clearInterval(syncIntervalId);
            syncIntervalId = setInterval(() => {
                syncWithSheet();
            }, SYNC_INTERVAL);
            // Executa um sync inicial
            syncWithSheet();
        }

        function stopAutoSync() {
            if (syncIntervalId) clearInterval(syncIntervalId);
        }

        // ============================================
        // FUNÇÕES DE CARREGAMENTO (EDIT/CLOSE)
        // ============================================
        function loadRecordForEdit(recordId) {
            const history = getMaintenanceHistory();
            const record = history.find(r => r.id === recordId);
            if (!record) return;

            state.editingId = record.id;
            state.placa = record.placa;
            state.tipoEquipamento = record.tipoEquipamento;
            state.dataHoraAbertura = record.dataHoraAbertura;
            state.dataHoraAvaria = formatDateTimeLocal(record.dataHoraAvaria);
            state.prioridade = record.prioridade;
            state.descricao = record.descricaoAvaria;
            state.local = record.localManutencao;
            state.responsavel = record.responsavelManutencao;
            state.observacoes = record.observacoes || '';
            state.statusOrdem = record.statusOrdem || 'Aberta';

            // Logica para campos Custom
            if (MAINTENANCE_TYPES.includes(record.tipoManutencao)) {
                state.tipoManutencao = record.tipoManutencao;
                state.showCustomManutencao = false;
            } else {
                state.tipoManutencao = 'Outro';
                state.tipoManutencaoCustom = record.tipoManutencao;
                state.showCustomManutencao = true;
            }

            if (WORKSHOPS.includes(record.oficina)) {
                state.oficina = record.oficina;
                state.showCustomOficina = false;
            } else {
                state.oficina = 'Outro';
                state.oficinaCustom = record.oficina;
                state.showCustomOficina = true;
            }

            const failures = FAILURES_BY_TYPE[record.tipoEquipamento] || [];
            if (failures.includes(record.tipoAvaria)) {
                state.tipoAvaria = record.tipoAvaria;
                state.showCustomAvaria = false;
            } else {
                state.tipoAvaria = 'Outro';
                state.tipoAvariaCustom = record.tipoAvaria;
                state.showCustomAvaria = true;
            }

            state.view = 'form';
            render();
        }

        function loadRecordForClose(recordId) {
            state.closingId = recordId;
            // Define data atual como padrão
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            state.dataHoraFechamento = now.toISOString().slice(0, 16);
            state.view = 'close';
            render();
        }

        // ============================================
        // RENDERERS (Simplificado para brevidade, mantendo lógica original)
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'login') {
                app.innerHTML = renderLogin();
            } else if (state.view === 'success') {
                app.innerHTML = renderSuccess();
            } else if (state.view === 'close') {
                app.innerHTML = renderLayout(renderCloseOrder(), 'Fechar Ordem');
            } else if (state.view === 'history') {
                app.innerHTML = renderLayout(renderHistory(), 'Histórico');
            } else {
                app.innerHTML = renderLayout(renderForm(), state.editingId ? 'Editar Ordem' : 'Nova Manutenção');
            }
        }

        function renderLayout(content, title) {
            const isHistory = state.view === 'history';
            return `
                <div class="min-h-screen bg-[#F5F5F5] pb-10">
                    <header class="bg-[#1F4E78] text-white p-4 sticky top-0 z-20 shadow-md flex justify-between items-center">
                        <div>
                            <h1 class="font-bold text-lg">${title}</h1>
                            <p class="text-xs opacity-80">Supervisor: ${state.supervisor}</p>
                        </div>
                        <div class="flex gap-3 items-center">
                            ${state.isSyncing ? '<i class="ph ph-spinner animate-spin text-xl"></i>' : ''}
                            <button onclick="state.view='${isHistory ? 'form' : 'history'}'; render()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ${isHistory ? 'ph-plus' : 'ph-clock-counter-clockwise'} text-2xl"></i>
                            </button>
                            <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ph-sign-out text-2xl"></i>
                            </button>
                        </div>
                    </header>
                    <main class="p-4 max-w-lg mx-auto">
                        ${content}
                    </main>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-[#1F4E78]">
                    <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div class="flex justify-center mb-6 text-[#1F4E78]">
                            <i class="ph ph-wrench text-6xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-center text-gray-800 mb-8">Manutenção Frota</h1>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-6">
                                <label class="text-sm font-bold text-gray-700 block mb-2">NOME DO SUPERVISOR</label>
                                <input type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-[#1F4E78] outline-none transition-colors"
                                    placeholder="Ex: João Silva" value="${state.supervisor}"
                                    oninput="state.supervisor = this.value" required />
                            </div>
                            <button type="submit" class="w-full bg-[#70AD47] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#5f963b] transition-colors">
                                ENTRAR NO SISTEMA
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderForm() {
            const filteredPlates = Object.keys(FLEET_DATA).filter(p => p.toLowerCase().includes(state.searchTerm.toLowerCase()));
            const failures = state.tipoEquipamento ? FAILURES_BY_TYPE[state.tipoEquipamento] || [] : [];
            
            return `
                <div class="space-y-6">
                    <!-- PLACA -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-truck text-xl"></i> Equipamento
                        </h3>
                        <div class="mb-4 relative">
                            <i class="ph ph-magnifying-glass absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="text" class="w-full border border-gray-300 rounded-lg p-3 pl-10"
                                placeholder="Buscar placa..." value="${state.searchTerm}"
                                oninput="state.searchTerm = this.value; render()">
                        </div>
                        <select class="w-full border border-gray-300 rounded-lg p-3 font-bold text-gray-800"
                            onchange="state.placa = this.value; state.tipoEquipamento = FLEET_DATA[this.value]; state.tipoAvaria=''; render()">
                            <option value="" disabled ${!state.placa ? 'selected' : ''}>Selecione a Placa</option>
                            ${filteredPlates.map(p => `<option value="${p}" ${state.placa === p ? 'selected' : ''}>${p} - ${FLEET_DATA[p]}</option>`).join('')}
                        </select>
                        ${state.tipoEquipamento ? `<div class="mt-2 text-sm text-blue-600 bg-blue-50 p-2 rounded"><i class="ph ph-info"></i> ${state.tipoEquipamento}</div>` : ''}
                    </div>

                    <!-- DETALHES -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-clipboard-text text-xl"></i> Detalhes
                        </h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Data da Avaria *</label>
                            <input type="datetime-local" class="w-full border border-gray-300 rounded-lg p-3"
                                value="${state.dataHoraAvaria}" oninput="state.dataHoraAvaria = this.value">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Prioridade *</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${PRIORITIES.map(p => `
                                    <button onclick="state.prioridade='${p}'; render()"
                                        class="py-2 rounded-lg text-xs font-bold border-2 ${state.prioridade === p ? getPriorityStyle(p) : 'bg-gray-50 text-gray-500 border-transparent'}">
                                        ${p}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Tipo de Manutenção *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.tipoManutencao = this.value; state.showCustomManutencao = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.tipoManutencao ? 'selected' : ''}>Selecione...</option>
                                ${MAINTENANCE_TYPES.map(t => `<option value="${t}" ${state.tipoManutencao === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                            ${state.showCustomManutencao ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Qual tipo?" value="${state.tipoManutencaoCustom}" oninput="state.tipoManutencaoCustom = this.value">` : ''}
                        </div>

                        ${state.tipoEquipamento ? `
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Componente/Avaria *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.tipoAvaria = this.value; state.showCustomAvaria = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.tipoAvaria ? 'selected' : ''}>Selecione...</option>
                                ${failures.map(f => `<option value="${f}" ${state.tipoAvaria === f ? 'selected' : ''}>${f}</option>`).join('')}
                            </select>
                            ${state.showCustomAvaria ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Qual avaria?" value="${state.tipoAvariaCustom}" oninput="state.tipoAvariaCustom = this.value">` : ''}
                        </div>
                        ` : ''}

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Descrição do Problema *</label>
                            <textarea class="w-full border border-gray-300 rounded-lg p-3 h-24 resize-none" 
                                placeholder="Detalhe o problema..." oninput="state.descricao = this.value">${state.descricao}</textarea>
                        </div>
                    </div>

                    <!-- LOCAL E RESPONSÁVEL -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-map-pin text-xl"></i> Execução
                        </h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Local onde está *</label>
                            <input type="text" class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="Ex: Base, Cliente..." value="${state.local}" oninput="state.local = this.value">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Oficina/Destino *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.oficina = this.value; state.showCustomOficina = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.oficina ? 'selected' : ''}>Selecione...</option>
                                ${WORKSHOPS.map(w => `<option value="${w}" ${state.oficina === w ? 'selected' : ''}>${w}</option>`).join('')}
                            </select>
                            ${state.showCustomOficina ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Nome da oficina" value="${state.oficinaCustom}" oninput="state.oficinaCustom = this.value">` : ''}
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Responsável/Mecânico *</label>
                            <input type="text" class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="Nome do responsável" value="${state.responsavel}" oninput="state.responsavel = this.value">
                        </div>
                    </div>

                    <!-- BOTÃO AÇÃO -->
                    <button onclick="handleSubmit()" ${state.isLoading ? 'disabled' : ''}
                        class="w-full py-4 rounded-xl text-white font-bold shadow-lg transition-all flex justify-center items-center gap-2 ${state.isLoading ? 'bg-gray-400' : 'bg-[#1F4E78] active:scale-95'}">
                        ${state.isLoading ? '<i class="ph ph-spinner animate-spin text-2xl"></i> PROCESSANDO...' : (state.editingId ? 'ATUALIZAR ORDEM' : 'ABRIR ORDEM')}
                    </button>
                    
                    ${state.editingId ? `<button onclick="state.view='form'; state.editingId=null; resetForm();" class="w-full py-3 text-gray-500 font-bold">CANCELAR EDIÇÃO</button>` : ''}
                </div>
            `;
        }

        function renderHistory() {
            const records = getMaintenanceHistory();
            if (records.length === 0) return `<div class="text-center py-10 text-gray-500"><i class="ph ph-files text-4xl mb-2"></i><br>Nenhum registro encontrado.</div>`;

            return `
                <div class="space-y-4">
                    ${records.map(r => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 ${r.statusOrdem === 'Concluída' ? 'border-green-500' : 'border-blue-500'}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-gray-800 text-lg">${r.placa}</h3>
                                <span class="text-xs px-2 py-1 rounded bg-gray-100 font-bold ${r.status === 'synced' ? 'text-green-600' : 'text-orange-500'}">
                                    ${r.status === 'synced' ? 'Sincronizado' : 'Pendente'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-semibold">Avaria:</span> ${r.tipoAvaria}</p>
                                <p><span class="font-semibold">Oficina:</span> ${r.oficina}</p>
                                <p><span class="font-semibold">Data:</span> ${formatDate(r.dataHoraAvaria)}</p>
                                <p><span class="font-semibold">Status:</span> ${r.statusOrdem}</p>
                            </div>
                            <div class="mt-3 flex gap-2 pt-3 border-t">
                                <button onclick="loadRecordForEdit('${r.id}')" class="flex-1 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold">EDITAR</button>
                                ${r.statusOrdem !== 'Concluída' ? 
                                    `<button onclick="loadRecordForClose('${r.id}')" class="flex-1 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold">FECHAR</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="localStorage.removeItem('maintenance_history'); render()" class="w-full py-4 text-red-400 text-sm">Limpar Histórico Local</button>
                </div>
            `;
        }

        function renderSuccess() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600">
                        <i class="ph ph-check text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h2>
                    <p class="text-gray-500 mb-8">A ordem foi salva corretamente.</p>
                    <button onclick="resetForm()" class="w-full bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg mb-4">NOVA ORDEM</button>
                    <button onclick="state.view='history'; render()" class="w-full border-2 border-gray-200 font-bold py-4 rounded-xl">VER HISTÓRICO</button>
                </div>
            `;
        }
        
        function renderCloseOrder() {
            const record = getMaintenanceHistory().find(r => r.id === state.closingId);
            if(!record) return 'Erro ao carregar';
            
            return `
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                   <h3 class="font-bold text-gray-800 mb-4">${record.placa} - ${record.tipoAvaria}</h3>
                   <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Data/Hora do Retorno *</label>
                        <input type="datetime-local" class="w-full border border-gray-300 rounded-lg p-3"
                            value="${state.dataHoraFechamento}" oninput="state.dataHoraFechamento = this.value">
                        <p class="text-xs text-gray-500 mt-2">Quando o veículo ficou pronto?</p>
                   </div>
                   <button onclick="handleCloseOrder()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg mb-3">
                        CONFIRMAR FECHAMENTO
                   </button>
                   <button onclick="state.view='history'; render()" class="w-full text-gray-500 font-bold py-3">CANCELAR</button>
                </div>
            `;
        }

        function getPriorityStyle(p) {
            const map = { 'URGENTE': 'bg-red-500 text-white border-red-500', 'ALTA': 'bg-orange-500 text-white border-orange-500', 'MEDIA': 'bg-yellow-400 text-black border-yellow-400', 'BAIXA': 'bg-green-500 text-white border-green-500' };
            return map[p] || '';
        }

        function resetForm() {
            state.editingId = null;
            state.closingId = null;
            state.placa = '';
            state.tipoEquipamento = '';
            state.tipoManutencao = '';
            state.prioridade = '';
            state.tipoAvaria = '';
            state.descricao = '';
            state.local = '';
            state.oficina = '';
            state.responsavel = '';
            state.observacoes = '';
            state.statusOrdem = 'Aberta';
            state.dataHoraAvaria = '';
            state.searchTerm = '';
            state.showCustomManutencao = false;
            state.showCustomOficina = false;
            state.showCustomAvaria = false;
            state.view = 'form';
            render();
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const savedSupervisor = localStorage.getItem('supervisor_name');
            if (savedSupervisor) {
                state.supervisor = savedSupervisor;
                state.view = 'form';
                startAutoSync();
            }
            render();
        });
        
        window.addEventListener('beforeunload', stopAutoSync);
    </script>
</body>
</html>
