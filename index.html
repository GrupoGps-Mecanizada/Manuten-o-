<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manutenção Frota</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Esconde barra de rolagem mas permite scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        // ⚠️ Substitua pela sua URL de implantação (Web App -> Anyone)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsmqHodlxOU2awdTe85nvqLtDaCWwOKYVToIElnGlWvq7AZsITb-D3_LUW88CnGroF0A/exec'; 
        
        const SYNC_INTERVAL = 30000;
        let syncIntervalId = null;

        // ============================================
        // DADOS
        // ============================================
        const FLEET_DATA = {
            "CZC-0453": "CAMINHÃO ALTA PRESSÃO", "DSY6472": "CAMINHÃO ALTA PRESSÃO",
            "DSY6474": "CAMINHÃO ALTA PRESSÃO", "DSY6475": "CAMINHÃO ALTA PRESSÃO",
            "DSY6F81": "CAMINHÃO ALTA PRESSÃO", "EAM-3253": "CAMINHÃO ALTA PRESSÃO",
            "EAM3255": "CAMINHÃO ALTA PRESSÃO", "EAM3256": "CAMINHÃO ALTA PRESSÃO",
            "EAM3262": "CAMINHÃO ALTA PRESSÃO", "EGC2978": "CAMINHÃO ALTA PRESSÃO",
            "EGC2983": "CAMINHÃO ALTA PRESSÃO", "EGC2985": "CAMINHÃO ALTA PRESSÃO",
            "EGC2989": "CAMINHÃO ALTA PRESSÃO", "EZS8764": "CAMINHÃO ALTA PRESSÃO",
            "LUX-3201": "CAMINHÃO ALTA PRESSÃO", "PUB2F80": "CAMINHÃO ALTA PRESSÃO",
            "ALY5322": "CAMINHÃO AUTO VÁCUO", "ANF-2676": "CAMINHÃO AUTO VÁCUO",
            "CUB0763": "CAMINHÃO AUTO VÁCUO", "DSY6473": "CAMINHÃO AUTO VÁCUO",
            "DSY6577": "CAMINHÃO AUTO VÁCUO", "DYB7210": "CAMINHÃO AUTO VÁCUO",
            "EAM3251": "CAMINHÃO AUTO VÁCUO", "EAM3257": "CAMINHÃO AUTO VÁCUO",
            "EGC2993": "CAMINHÃO AUTO VÁCUO", "FSA3D71": "CAMINHÃO AUTO VÁCUO",
            "HJS1097": "CAMINHÃO AUTO VÁCUO", "DSY6477": "CAMINHÃO BROOK",
            "EGC-2984": "CAMINHÃO BROOK", "EPN2463": "CAMINHÃO BROOK",
            "HKH2H79": "CAMINHÃO BROOK", "DSY6471": "CAMINHÃO HIPER VÁCUO",
            "FHD9264": "CAMINHÃO HIPER VÁCUO", "FMD2200": "CAMINHÃO HIPER VÁCUO",
            "ASP02": "ASPIRADOR", "ASP04": "ASPIRADOR", "ASP06": "ASPIRADOR",
            "ASP07": "ASPIRADOR", "ASP08": "ASPIRADOR", "ASP09": "ASPIRADOR",
            "ASP10": "ASPIRADOR", "ASP12": "ASPIRADOR", "ASP12-RESERVA": "ASPIRADOR",
            "ASPII": "ASPIRADOR"
        };

        const MAINTENANCE_TYPES = ["Preventiva", "Corretiva", "Preditiva", "Emergencial", "Outro"];
        
        // NOVAS OPÇÕES DE OFICINA
        const WORKSHOPS = ["SERVITEC", "PARANA MOLAS", "BORRACHARIA", "Outro"];
        
        const FAILURES_BY_TYPE = {
            "CAMINHÃO ALTA PRESSÃO": ["Bomba Alta Pressão", "Mangueira Alta Pressão", "Bico Rotativo", "Motor Bomba", "Sistema Hidráulico", "Válvulas de Pressão", "Filtros Bomba", "Tanque de Água", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO AUTO VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO HIPER VÁCUO": ["Bomba de Vácuo", "Tanque de Sucção", "Mangueira de Sucção", "Sistema de Descarga", "Válvulas de Vácuo", "Filtros", "Sistema Hidráulico", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "CAMINHÃO BROOK": ["Sistema de Desobstrução", "Lança/Braço Mecânico", "Mangueiras", "Sistema Hidráulico", "Cabos de Aço", "Filtros", "Motor do Caminhão", "Transmissão", "Freios", "Suspensão", "Sistema Elétrico", "Pneus", "Outro"],
            "ASPIRADOR": ["Motor de Sucção", "Filtros", "Mangueiras", "Sistema Elétrico", "Tanque", "Outro"]
        };

        // ============================================
        // ESTADO
        // ============================================
        let state = {
            view: 'login',
            supervisor: '',
            editingId: null,
            closingId: null,
            // Campos do Formulário
            placa: '',
            tipoEquipamento: '',
            tipoManutencao: '',
            tipoManutencaoCustom: '',
            tipoAvaria: '',
            tipoAvariaCustom: '',
            descricao: '',
            oficina: '',
            oficinaCustom: '',
            responsavel: '',
            observacoes: '',
            dataHoraAvaria: '',
            // Campos de Fechamento
            dataHoraFechamento: '',
            statusFechamento: '', // Aprovada ou Rejeitada
            // Controle
            statusOrdem: 'Aberta',
            searchTerm: '',
            isLoading: false,
            isSyncing: false,
            showCustomManutencao: false,
            showCustomOficina: false,
            showCustomAvaria: false
        };

        // ============================================
        // SERVIÇOS
        // ============================================
        async function submitToSheet(record) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify(record)
                });
                const data = await response.json();
                return { success: data.success, message: data.error };
            } catch (error) {
                console.error('Erro rede:', error);
                return { success: false, message: error.message };
            }
        }

        async function fetchFromSheet() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET', redirect: 'follow' });
                const data = await response.json();
                if (data.success && data.records) {
                    localStorage.setItem('maintenance_history', JSON.stringify(data.records));
                    return true;
                }
                return false;
            } catch (error) { return false; }
        }

        async function syncWithSheet() {
            if (state.isSyncing) return;
            state.isSyncing = true;
            render(); 

            const history = getMaintenanceHistory();
            const pending = history.filter(r => r.status === 'pending');
            
            for (const record of pending) {
                const result = await submitToSheet(record);
                if (result.success) updateHistoryStatus(record.id, 'synced');
            }
            await fetchFromSheet();
            
            state.isSyncing = false;
            render();
        }

        // ============================================
        // UTILITÁRIOS & STORAGE
        // ============================================
        function getMaintenanceHistory() {
            return JSON.parse(localStorage.getItem('maintenance_history') || '[]');
        }

        function saveToHistory(record) {
            const history = getMaintenanceHistory();
            const idx = history.findIndex(r => r.id === record.id);
            if (idx !== -1) history[idx] = record;
            else history.unshift(record);
            localStorage.setItem('maintenance_history', JSON.stringify(history));
        }

        function updateHistoryStatus(id, status) {
            const history = getMaintenanceHistory();
            const item = history.find(r => r.id === id);
            if (item) {
                item.status = status;
                localStorage.setItem('maintenance_history', JSON.stringify(history));
            }
        }

        function formatDateTimeLocal(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return '';
            const offsetMs = date.getTimezoneOffset() * 60 * 1000;
            return new Date(date.getTime() - offsetMs).toISOString().slice(0, 16);
        }

        function formatDate(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            return isNaN(date.getTime()) ? isoDate : date.toLocaleString('pt-BR');
        }

        // ============================================
        // LOGICA DE NEGÓCIO
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            if (!state.supervisor.trim()) return;
            localStorage.setItem('supervisor_name', state.supervisor);
            state.view = 'form';
            startAutoSync();
            render();
        }

        function handleLogout() {
            if (syncIntervalId) clearInterval(syncIntervalId);
            localStorage.removeItem('supervisor_name');
            state.supervisor = '';
            state.view = 'login';
            render();
        }

        function startAutoSync() {
            if (syncIntervalId) clearInterval(syncIntervalId);
            syncIntervalId = setInterval(syncWithSheet, SYNC_INTERVAL);
            syncWithSheet();
        }

        async function handleSubmit() {
            const { placa, tipoManutencao, tipoManutencaoCustom, tipoAvaria, tipoAvariaCustom, 
                    descricao, oficina, oficinaCustom, responsavel, dataHoraAvaria } = state;
            
            // Validação simplificada (sem Prioridade e Local)
            if (!placa || !descricao || !responsavel || !dataHoraAvaria) {
                alert("Preencha campos com *");
                return;
            }

            const finalManutencao = tipoManutencao === 'Outro' ? tipoManutencaoCustom.trim() : tipoManutencao;
            const finalOficina = oficina === 'Outro' ? oficinaCustom.trim() : oficina;
            const finalAvaria = tipoAvaria === 'Outro' ? tipoAvariaCustom.trim() : tipoAvaria;

            if (!finalManutencao || !finalOficina || !finalAvaria) {
                alert("Preencha os campos 'Outro' corretamente.");
                return;
            }

            state.isLoading = true;
            render();

            const record = {
                id: state.editingId || `ORD-${Date.now()}`,
                dataHoraAbertura: state.editingId ? state.dataHoraAbertura : new Date().toISOString(),
                dataHoraAvaria: new Date(dataHoraAvaria).toISOString(),
                dataHoraFechamento: state.dataHoraFechamento ? new Date(state.dataHoraFechamento).toISOString() : null,
                supervisor: state.supervisor,
                placa,
                tipoEquipamento: state.tipoEquipamento,
                tipoManutencao: finalManutencao,
                tipoAvaria: finalAvaria,
                descricaoAvaria: descricao.trim(),
                oficina: finalOficina,
                responsavelManutencao: responsavel.trim(),
                observacoes: state.observacoes.trim(),
                statusOrdem: state.statusOrdem,
                status: 'pending'
            };

            saveToHistory(record);
            const result = await submitToSheet(record);

            state.isLoading = false;
            if (result.success) updateHistoryStatus(record.id, 'synced');
            
            state.view = 'success';
            state.editingId = null;
            render();
        }

        async function handleCloseOrder() {
            if (!state.dataHoraFechamento) {
                alert('Informe a data/hora de retorno.');
                return;
            }
            if (!state.statusFechamento) {
                alert('Selecione se a manutenção foi Aprovada ou Rejeitada.');
                return;
            }

            state.isLoading = true;
            render();

            const history = getMaintenanceHistory();
            const record = history.find(r => r.id === state.closingId);

            if (record) {
                record.dataHoraFechamento = new Date(state.dataHoraFechamento).toISOString();
                // Aqui define o status final
                record.statusOrdem = `Manutenção ${state.statusFechamento}`;
                record.status = 'pending';
                
                saveToHistory(record);
                const result = await submitToSheet(record);
                if (result.success) updateHistoryStatus(record.id, 'synced');
            }

            state.isLoading = false;
            state.closingId = null;
            state.statusFechamento = '';
            state.view = 'success';
            render();
        }

        // ============================================
        // CARREGAMENTO DE DADOS
        // ============================================
        function loadRecordForEdit(id) {
            const r = getMaintenanceHistory().find(x => x.id === id);
            if (!r) return;

            state.editingId = r.id;
            state.placa = r.placa;
            state.tipoEquipamento = r.tipoEquipamento;
            state.dataHoraAbertura = r.dataHoraAbertura;
            state.dataHoraAvaria = formatDateTimeLocal(r.dataHoraAvaria);
            state.descricao = r.descricaoAvaria;
            state.responsavel = r.responsavelManutencao;
            state.observacoes = r.observacoes || '';
            state.statusOrdem = r.statusOrdem;

            // Lógica Inputs Custom
            if (MAINTENANCE_TYPES.includes(r.tipoManutencao)) {
                state.tipoManutencao = r.tipoManutencao;
                state.showCustomManutencao = false;
            } else {
                state.tipoManutencao = 'Outro';
                state.tipoManutencaoCustom = r.tipoManutencao;
                state.showCustomManutencao = true;
            }

            if (WORKSHOPS.includes(r.oficina)) {
                state.oficina = r.oficina;
                state.showCustomOficina = false;
            } else {
                state.oficina = 'Outro';
                state.oficinaCustom = r.oficina;
                state.showCustomOficina = true;
            }

            const failures = FAILURES_BY_TYPE[r.tipoEquipamento] || [];
            if (failures.includes(r.tipoAvaria)) {
                state.tipoAvaria = r.tipoAvaria;
                state.showCustomAvaria = false;
            } else {
                state.tipoAvaria = 'Outro';
                state.tipoAvariaCustom = r.tipoAvaria;
                state.showCustomAvaria = true;
            }

            state.view = 'form';
            render();
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            let content = '';
            let title = '';

            switch (state.view) {
                case 'login': return app.innerHTML = renderLogin();
                case 'success': return app.innerHTML = renderSuccess();
                case 'close': 
                    content = renderCloseOrder();
                    title = 'Fechar Ordem';
                    break;
                case 'history':
                    content = renderHistory();
                    title = 'Histórico';
                    break;
                default: // form
                    content = renderForm();
                    title = state.editingId ? 'Editar Ordem' : 'Nova Manutenção';
            }
            
            app.innerHTML = `
                <div class="min-h-screen bg-[#F5F5F5] pb-10">
                    <header class="bg-[#1F4E78] text-white p-4 sticky top-0 z-30 shadow-md flex justify-between items-center">
                        <div>
                            <h1 class="font-bold text-lg">${title}</h1>
                            <p class="text-xs opacity-80 uppercase">${state.supervisor}</p>
                        </div>
                        <div class="flex gap-3 items-center">
                            ${state.isSyncing ? '<i class="ph ph-spinner animate-spin text-xl"></i>' : ''}
                            <button onclick="state.view='${state.view === 'history' ? 'form' : 'history'}'; render()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ${state.view === 'history' ? 'ph-plus' : 'ph-clock-counter-clockwise'} text-2xl"></i>
                            </button>
                            <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white/10">
                                <i class="ph ph-sign-out text-2xl"></i>
                            </button>
                        </div>
                    </header>
                    <main class="p-4 max-w-lg mx-auto">${content}</main>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-[#1F4E78]">
                    <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div class="flex justify-center mb-6 text-[#1F4E78]"><i class="ph ph-wrench text-6xl"></i></div>
                        <h1 class="text-2xl font-bold text-center text-gray-800 mb-8">Manutenção Frota</h1>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-6">
                                <label class="text-sm font-bold text-gray-700 block mb-2">NOME DO SUPERVISOR</label>
                                <input type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-[#1F4E78] outline-none"
                                    value="${state.supervisor}" oninput="state.supervisor = this.value" required placeholder="Digite seu nome">
                            </div>
                            <button type="submit" class="w-full bg-[#70AD47] text-white font-bold py-4 rounded-xl shadow-lg">ENTRAR</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderForm() {
            // Lógica de Filtro Inteligente da Placa
            const allPlates = Object.keys(FLEET_DATA);
            const filteredPlates = state.searchTerm 
                ? allPlates.filter(p => p.toLowerCase().includes(state.searchTerm.toLowerCase()))
                : allPlates;
            
            const failures = state.tipoEquipamento ? FAILURES_BY_TYPE[state.tipoEquipamento] || [] : [];

            return `
                <div class="space-y-6">
                    <!-- PLACA INTELIGENTE -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-truck text-xl"></i> Equipamento
                        </h3>
                        
                        <div class="mb-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Filtrar Placa</label>
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="text" class="w-full border border-gray-300 rounded-lg p-3 pl-10"
                                    placeholder="Digite número ou letras..." 
                                    value="${state.searchTerm}"
                                    oninput="state.searchTerm = this.value; render()"> <!-- Re-renderiza ao digitar -->
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Selecionar Veículo *</label>
                            <select class="w-full border-2 border-gray-200 rounded-lg p-3 font-bold text-gray-800 focus:border-[#1F4E78]"
                                onchange="state.placa = this.value; state.tipoEquipamento = FLEET_DATA[this.value]; state.tipoAvaria=''; state.searchTerm=''; render()">
                                <option value="" disabled ${!state.placa ? 'selected' : ''}>
                                    ${filteredPlates.length === 0 ? 'Nenhuma placa encontrada' : 'Selecione na lista abaixo...'}
                                </option>
                                ${filteredPlates.map(p => `
                                    <option value="${p}" ${state.placa === p ? 'selected' : ''}>${p} - ${FLEET_DATA[p]}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${state.tipoEquipamento ? `
                            <div class="mt-2 text-sm text-blue-800 bg-blue-50 p-3 rounded-lg flex items-center gap-2 border border-blue-100">
                                <i class="ph ph-info text-lg"></i>
                                <span class="font-semibold">${state.tipoEquipamento}</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- DETALHES -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-clipboard-text text-xl"></i> Detalhes
                        </h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Data da Avaria *</label>
                            <input type="datetime-local" class="w-full border border-gray-300 rounded-lg p-3"
                                value="${state.dataHoraAvaria}" oninput="state.dataHoraAvaria = this.value">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Tipo de Manutenção *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.tipoManutencao = this.value; state.showCustomManutencao = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.tipoManutencao ? 'selected' : ''}>Selecione...</option>
                                ${MAINTENANCE_TYPES.map(t => `<option value="${t}" ${state.tipoManutencao === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                            ${state.showCustomManutencao ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Especifique..." value="${state.tipoManutencaoCustom}" oninput="state.tipoManutencaoCustom = this.value">` : ''}
                        </div>

                        ${state.tipoEquipamento ? `
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Componente/Avaria *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.tipoAvaria = this.value; state.showCustomAvaria = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.tipoAvaria ? 'selected' : ''}>Selecione...</option>
                                ${failures.map(f => `<option value="${f}" ${state.tipoAvaria === f ? 'selected' : ''}>${f}</option>`).join('')}
                            </select>
                            ${state.showCustomAvaria ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Especifique..." value="${state.tipoAvariaCustom}" oninput="state.tipoAvariaCustom = this.value">` : ''}
                        </div>
                        ` : ''}

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Descrição do Problema *</label>
                            <textarea class="w-full border border-gray-300 rounded-lg p-3 h-24 resize-none" 
                                placeholder="Detalhe o problema..." oninput="state.descricao = this.value">${state.descricao}</textarea>
                        </div>
                    </div>

                    <!-- EXECUÇÃO -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-[#1F4E78] mb-4 border-b pb-2 flex items-center gap-2">
                            <i class="ph ph-wrench text-xl"></i> Execução
                        </h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Oficina / Destino *</label>
                            <select class="w-full border border-gray-300 rounded-lg p-3 bg-white"
                                onchange="state.oficina = this.value; state.showCustomOficina = (this.value === 'Outro'); render()">
                                <option value="" disabled ${!state.oficina ? 'selected' : ''}>Selecione...</option>
                                ${WORKSHOPS.map(w => `<option value="${w}" ${state.oficina === w ? 'selected' : ''}>${w}</option>`).join('')}
                            </select>
                            ${state.showCustomOficina ? `<input type="text" class="mt-2 w-full border border-gray-300 rounded-lg p-3" placeholder="Digite o nome da oficina..." value="${state.oficinaCustom}" oninput="state.oficinaCustom = this.value">` : ''}
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Responsável/Mecânico *</label>
                            <input type="text" class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="Nome do responsável" value="${state.responsavel}" oninput="state.responsavel = this.value">
                        </div>
                    </div>

                    <button onclick="handleSubmit()" ${state.isLoading ? 'disabled' : ''}
                        class="w-full py-4 rounded-xl text-white font-bold shadow-lg flex justify-center items-center gap-2 ${state.isLoading ? 'bg-gray-400' : 'bg-[#1F4E78] active:scale-95'}">
                        ${state.isLoading ? '<i class="ph ph-spinner animate-spin text-2xl"></i> PROCESSANDO...' : (state.editingId ? 'ATUALIZAR ORDEM' : 'ABRIR ORDEM')}
                    </button>
                    
                    ${state.editingId ? `<button onclick="resetForm()" class="w-full py-3 text-gray-500 font-bold">CANCELAR EDIÇÃO</button>` : ''}
                </div>
            `;
        }

        function renderCloseOrder() {
            const r = getMaintenanceHistory().find(x => x.id === state.closingId);
            if(!r) return 'Erro';

            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="font-bold text-xl text-gray-800">${r.placa}</h3>
                        <p class="text-sm text-gray-500">${r.tipoAvaria}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Data/Hora de Retorno *</label>
                        <input type="datetime-local" class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-[#1F4E78]"
                            value="${state.dataHoraFechamento}" oninput="state.dataHoraFechamento = this.value">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">Resultado da Manutenção *</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="state.statusFechamento='Aprovada'; render()"
                                class="p-4 rounded-xl border-2 font-bold transition-all flex flex-col items-center gap-2
                                ${state.statusFechamento === 'Aprovada' 
                                    ? 'bg-green-50 border-green-500 text-green-700' 
                                    : 'border-gray-200 text-gray-400 hover:bg-gray-50'}">
                                <i class="ph ph-thumbs-up text-3xl"></i>
                                Aprovada
                            </button>
                            
                            <button onclick="state.statusFechamento='Rejeitada'; render()"
                                class="p-4 rounded-xl border-2 font-bold transition-all flex flex-col items-center gap-2
                                ${state.statusFechamento === 'Rejeitada' 
                                    ? 'bg-red-50 border-red-500 text-red-700' 
                                    : 'border-gray-200 text-gray-400 hover:bg-gray-50'}">
                                <i class="ph ph-thumbs-down text-3xl"></i>
                                Rejeitada
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 space-y-3">
                        <button onclick="handleCloseOrder()" class="w-full bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg">
                            CONFIRMAR E FECHAR
                        </button>
                        <button onclick="state.view='history'; state.closingId=null; render()" class="w-full text-gray-500 font-bold py-3">
                            CANCELAR
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            const records = getMaintenanceHistory();
            if (!records.length) return `<div class="text-center py-12 text-gray-400"><i class="ph ph-files text-4xl mb-2"></i><p>Nenhum registro</p></div>`;

            return `
                <div class="space-y-4">
                    ${records.map(r => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 
                            ${r.statusOrdem.includes('Aprovada') ? 'border-green-500' : 
                              r.statusOrdem.includes('Rejeitada') ? 'border-red-500' : 
                              r.statusOrdem === 'Aberta' ? 'border-blue-500' : 'border-gray-300'}">
                            
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-gray-800 text-lg">${r.placa}</h3>
                                <span class="text-[10px] px-2 py-1 rounded-full font-bold uppercase
                                    ${r.status === 'synced' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                    ${r.status === 'synced' ? 'Sync OK' : 'Pendente'}
                                </span>
                            </div>
                            
                            <div class="text-sm text-gray-600 space-y-1 mb-3">
                                <p class="truncate"><i class="ph ph-wrench mr-1"></i> ${r.tipoAvaria}</p>
                                <p class="truncate"><i class="ph ph-storefront mr-1"></i> ${r.oficina}</p>
                                <p><i class="ph ph-calendar mr-1"></i> ${formatDate(r.dataHoraAvaria)}</p>
                                <div class="mt-2 inline-block px-2 py-1 rounded text-xs font-bold
                                    ${r.statusOrdem.includes('Aprovada') ? 'bg-green-100 text-green-800' : 
                                      r.statusOrdem.includes('Rejeitada') ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                    ${r.statusOrdem}
                                </div>
                            </div>

                            <div class="flex gap-2 border-t pt-3">
                                <button onclick="loadRecordForEdit('${r.id}')" class="flex-1 py-2 bg-gray-50 text-gray-700 rounded-lg text-xs font-bold hover:bg-gray-100">EDITAR</button>
                                ${!r.statusOrdem.includes('Manutenção') ? 
                                    `<button onclick="state.closingId='${r.id}'; loadRecordForClose('${r.id}')" class="flex-1 py-2 bg-[#1F4E78] text-white rounded-lg text-xs font-bold">FECHAR</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="if(confirm('Limpar?')) { localStorage.removeItem('maintenance_history'); render(); }" class="w-full py-6 text-red-300 text-xs">Limpar Cache Local</button>
                </div>
            `;
        }

        function renderSuccess() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 animate-bounce">
                        <i class="ph ph-check text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h2>
                    <p class="text-gray-500 mb-8">Operação realizada com sucesso.</p>
                    <button onclick="resetForm()" class="w-full bg-[#1F4E78] text-white font-bold py-4 rounded-xl shadow-lg mb-4">NOVA ORDEM</button>
                    <button onclick="state.view='history'; render()" class="w-full border-2 border-gray-200 font-bold py-4 rounded-xl text-gray-600">VER HISTÓRICO</button>
                </div>
            `;
        }

        function resetForm() {
            state.editingId = null;
            state.closingId = null;
            state.placa = '';
            state.tipoEquipamento = '';
            state.tipoManutencao = '';
            state.tipoManutencaoCustom = '';
            state.tipoAvaria = '';
            state.tipoAvariaCustom = '';
            state.descricao = '';
            state.oficina = '';
            state.oficinaCustom = '';
            state.responsavel = '';
            state.observacoes = '';
            state.dataHoraAvaria = '';
            state.searchTerm = '';
            state.statusOrdem = 'Aberta';
            state.showCustomManutencao = false;
            state.showCustomOficina = false;
            state.showCustomAvaria = false;
            state.view = 'form';
            render();
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const savedSupervisor = localStorage.getItem('supervisor_name');
            if (savedSupervisor) {
                state.supervisor = savedSupervisor;
                state.view = 'form';
                startAutoSync();
            }
            render();
        });
        window.addEventListener('beforeunload', () => clearInterval(syncIntervalId));
    </script>
</body>
</html>
